# üìä An√°lisis COMPLETO de Base de Datos OptimaCX - Tablas Faltantes y Conexiones

## üîç Resumen del An√°lisis ACTUALIZADO

Basado en la revisi√≥n COMPLETA de:
- ‚úÖ Documentaci√≥n CLAUDE.md (requerimientos del negocio)
- ‚úÖ Workflows existentes en N8N (25+ workflows analizados)
- ‚úÖ Esquema ACTUAL de base de datos Supabase (VERIFICADO CON MCP)
- ‚úÖ Migraciones implementadas hasta hoy
- ‚úÖ **An√°lisis de conectividad N8N ‚Üî Supabase ‚Üî Cloud SQL**

## üéØ **ARQUITECTURA ACTUAL CONFIRMADA**

### üèóÔ∏è Bases de Datos en Uso:
1. **Supabase PostgreSQL** (Principal) - ‚úÖ **ACTIVA Y VERIFICADA**
   - URL: `https://gdnlodwwmvbgayzzudiu.supabase.co`
   - Estado: ‚úÖ Reactivada y funcionando
   - Uso: Frontend, API REST, tablas principales de negocio

2. **Cloud SQL para N8N** - Workflows y metadata
3. **Cloud SQL para Chatwoot** - Conversaciones y chat

## ‚úÖ Tablas Existentes (VERIFICADAS CON MCP DE SUPABASE)

### **CORE MULTITENANT** ‚úÖ COMPLETO
- ‚úÖ `concesionarios` - Tenants principales
- ‚úÖ `sucursales` - Sucursales por concesionario  
- ‚úÖ `users` - Usuarios con roles espec√≠ficos (user_id, role, concesionario_id)

### **M√ìDULO CLIENTES** ‚úÖ COMPLETO
- ‚úÖ `clientes` - Datos de clientes (RUT, nombre, contacto)
- ‚úÖ `vehiculos` - Veh√≠culos por cliente (patente, VIN, marca, modelo)

### **M√ìDULO DE VENTAS** ‚úÖ COMPLETO
- ‚úÖ `leads` - Gesti√≥n de leads/prospectos con scoring
- ‚úÖ `productos` - Cat√°logo de veh√≠culos y productos
- ‚úÖ `cotizaciones` - Cotizaciones generadas
- ‚úÖ `items_cotizacion` - Items espec√≠ficos de cotizaciones
- ‚úÖ `ventas` - Ventas cerradas
- ‚úÖ `items_venta` - Items de ventas realizadas

### **M√ìDULO SERVICIO T√âCNICO** ‚úÖ COMPLETO
- ‚úÖ `citas` - Agendamiento de servicios
- ‚úÖ `servicios` - √ìrdenes de trabajo y servicios
- ‚úÖ `items_servicio` - Repuestos y trabajos realizados

### **M√ìDULO RECLAMOS** ‚úÖ COMPLETO
- ‚úÖ `reclamos` - Gesti√≥n de reclamos con IA
- ‚úÖ `categorias_reclamo` - Categorizaci√≥n de reclamos
- ‚úÖ `seguimientos_reclamo` - Historial de seguimientos

### **M√ìDULO ENCUESTAS** ‚úÖ COMPLETO
- ‚úÖ `encuestas` - Definici√≥n de encuestas (ventas y post-venta)
- ‚úÖ `preguntas` - Preguntas de las encuestas
- ‚úÖ `respuestas_encuesta` - Respuestas completas
- ‚úÖ `respuestas_pregunta` - Respuestas por pregunta espec√≠fica

## ‚ùå **TABLAS FALTANTES CR√çTICAS IDENTIFICADAS**

### üî¥ **1. CONFIGURACI√ìN MULTITENANT** - **PRIORIDAD CR√çTICA**
```sql
-- ‚ùå FALTANTE: Configuraciones espec√≠ficas por concesionario
CREATE TABLE configuraciones_concesionario (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id) UNIQUE,
    configuracion JSONB NOT NULL DEFAULT '{}',
    webhook_n8n_base TEXT, -- https://n8n-optimacx-supabase-xxx.run.app/webhook/
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ‚ùå FALTANTE: Integraciones externas por concesionario
CREATE TABLE integraciones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    tipo_integracion TEXT NOT NULL, -- 'whatsapp', 'n8n', 'chatwoot', 'email'
    nombre TEXT NOT NULL,
    configuracion JSONB NOT NULL, -- Credenciales y config espec√≠fica
    estado TEXT DEFAULT 'activo',
    ultimo_sync TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```
**‚ùó Sin estas tablas, los workflows de N8N no pueden funcionar espec√≠ficamente por concesionario.**

### üî¥ **2. SISTEMA DE NOTIFICACIONES** - **PRIORIDAD CR√çTICA**
```sql
-- ‚ùå FALTANTE: Gesti√≥n centralizada de comunicaciones
CREATE TABLE notificaciones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    usuario_id UUID REFERENCES users(user_id),
    cliente_id UUID REFERENCES clientes(id),
    tipo_notificacion TEXT NOT NULL, -- 'email', 'whatsapp', 'sms'
    titulo TEXT NOT NULL,
    contenido TEXT NOT NULL,
    estado TEXT DEFAULT 'pendiente', -- 'enviado', 'entregado', 'fallido'
    canal_envio TEXT, -- 'n8n', 'chatwoot', 'manual'
    referencia_id UUID, -- ID del lead, venta, reclamo, etc.
    referencia_tipo TEXT, -- 'lead', 'venta', 'reclamo', 'encuesta'
    metadata JSONB,
    enviado_en TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ‚ùå FALTANTE: Templates de comunicaci√≥n por concesionario
CREATE TABLE templates_comunicacion (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    nombre TEXT NOT NULL,
    tipo TEXT NOT NULL, -- 'email', 'whatsapp', 'sms'
    categoria TEXT NOT NULL, -- 'bienvenida', 'seguimiento', 'encuesta'
    asunto TEXT,
    contenido TEXT NOT NULL,
    variables JSONB, -- {nombre}, {vehiculo}, {fecha}, etc.
    es_activo BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```
**‚ùó Sin estas tablas, no se pueden enviar comunicaciones autom√°ticas diferenciadas por concesionario.**

### üî¥ **3. AUDITOR√çA Y LOGS** - **PRIORIDAD ALTA**
```sql
-- ‚ùå FALTANTE: Logs de automatizaciones
CREATE TABLE logs_automatizacion (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    tipo_workflow TEXT NOT NULL, -- 'lead_seguimiento', 'encuesta_envio'
    referencia_id UUID,
    referencia_tipo TEXT,
    estado TEXT NOT NULL, -- 'iniciado', 'completado', 'error'
    n8n_execution_id TEXT,
    datos_entrada JSONB,
    datos_salida JSONB,
    error_mensaje TEXT,
    tiempo_procesamiento INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ‚ùå FALTANTE: Auditor√≠a de acciones cr√≠ticas
CREATE TABLE auditoria (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    usuario_id UUID REFERENCES users(user_id),
    accion TEXT NOT NULL, -- 'crear', 'editar', 'eliminar'
    tabla_afectada TEXT NOT NULL,
    registro_id UUID,
    datos_anteriores JSONB,
    datos_nuevos JSONB,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### üü° **4. M√âTRICAS Y DASHBOARD** - **PRIORIDAD MEDIA**
```sql
-- ‚ùå FALTANTE: M√©tricas consolidadas
CREATE TABLE metricas_dashboard (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    sucursal_id UUID REFERENCES sucursales(id),
    fecha DATE NOT NULL,
    tipo_metrica TEXT NOT NULL, -- 'ventas', 'leads', 'satisfaccion'
    metrica JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(concesionario_id, sucursal_id, fecha, tipo_metrica)
);

-- ‚ùå FALTANTE: Gesti√≥n de archivos
CREATE TABLE archivos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID REFERENCES concesionarios(id),
    uploaded_by UUID REFERENCES users(user_id),
    referencia_id UUID,
    referencia_tipo TEXT, -- 'reclamo', 'venta', 'servicio'
    nombre_archivo TEXT NOT NULL,
    tipo_mime TEXT NOT NULL,
    url_storage TEXT NOT NULL, -- Cloud Storage URL
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## üîó **CONEXIONES FALTANTES CR√çTICAS**

### ‚ùå **1. VIN en Encuestas**
```sql
-- Los workflows mencionan VIN pero no est√° en las encuestas
ALTER TABLE respuestas_encuesta ADD COLUMN vin TEXT;
CREATE INDEX idx_respuestas_encuesta_vin ON respuestas_encuesta(vin);
```

### ‚ùå **2. Conexi√≥n N8N ‚Üí Supabase**
**Variables de entorno faltantes en Cloud Run N8N:**
```env
SUPABASE_URL=https://gdnlodwwmvbgayzzudiu.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOi...
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOi...
```

### ‚ùå **3. Pol√≠ticas RLS Faltantes**
Muchas tablas no tienen Row Level Security configurado correctamente.

## üö® **PROBLEMAS CR√çTICOS DETECTADOS**

### 1. **Workflows de N8N sin acceso a Supabase**
- Los workflows hacen referencia a tablas de Supabase
- Pero N8N (Cloud Run) no tiene configuradas las credenciales
- **Resultado**: Los workflows fallan silenciosamente

### 2. **Configuraci√≥n Multitenant Incompleta**
- No hay tabla para configuraciones espec√≠ficas por concesionario
- WhatsApp, emails, y otras integraciones no pueden ser espec√≠ficas
- **Resultado**: Todos los concesionarios comparten la misma configuraci√≥n

### 3. **Sistema de Comunicaciones Incompleto**
- No hay gesti√≥n centralizada de notificaciones
- No hay templates diferenciados por concesionario
- **Resultado**: Comunicaciones gen√©ricas sin personalizaci√≥n

## üöÄ **PLAN DE IMPLEMENTACI√ìN INMEDIATA**

### **FASE 1: CR√çTICO (IMPLEMENTAR HOY)**
1. ‚úÖ `configuraciones_concesionario` 
2. ‚úÖ `integraciones`
3. ‚úÖ Agregar VIN a encuestas
4. ‚ö†Ô∏è Configurar variables N8N ‚Üí Supabase

### **FASE 2: ALTO (ESTA SEMANA)**
1. ‚úÖ `notificaciones`
2. ‚úÖ `templates_comunicacion`
3. ‚úÖ `logs_automatizacion`

### **FASE 3: MEDIO (PR√ìXIMA SEMANA)**
1. ‚úÖ `auditoria`
2. ‚úÖ `archivos`
3. ‚úÖ `metricas_dashboard`

## üîß **SCRIPTS LISTOS PARA EJECUTAR**

¬øQuieres que ejecute las migraciones de **FASE 1 (CR√çTICO)** ahora mismo en tu base de datos Supabase?

Tengo los scripts SQL preparados y el MCP de Supabase funcionando correctamente.

## ‚ö†Ô∏è **RECOMENDACIONES FINALES**

1. **BACKUP**: Hacer snapshot de Supabase antes de migraciones
2. **RLS**: Implementar pol√≠ticas de seguridad en tablas nuevas  
3. **√çNDICES**: Agregar √≠ndices en campos frecuentemente consultados
4. **MONITORING**: Implementar logs de automatizaci√≥n desde el inicio

**¬øProcedo con la implementaci√≥n de las tablas cr√≠ticas?**
- ‚úÖ `cotizaciones` - Cotizaciones de ventas
- ‚úÖ `ventas` - Ventas concretadas

### **M√ìDULO DE ENCUESTAS**
- ‚úÖ `encuestas` - Encuestas post-venta (base)
- ‚úÖ `encuestas_ventas` - Encuestas de satisfacci√≥n de ventas
- ‚úÖ `casos_feedback_postventa` - Casos de feedback de baja satisfacci√≥n
- ‚úÖ `casos_feedback_ventas` - Casos de feedback de ventas

### **M√ìDULO DE SERVICIOS**
- ‚úÖ `servicios` - Servicios post-venta
- ‚úÖ `citas` - Citas de servicio
- ‚úÖ `items_servicio` - Items/trabajos de servicio

### **SOPORTE GENERAL**
- ‚úÖ `vehiculos` - Veh√≠culos de clientes
- ‚úÖ `clientes` - Base de clientes
- ‚úÖ `items_cotizacion` - Items de cotizaciones
- ‚úÖ `items_venta` - Items de ventas

---

## üö® Tablas CR√çTICAS Faltantes

### **1. CONFIGURACI√ìN MULTITENANT** (ALTA PRIORIDAD)
```sql
-- TABLA FALTANTE: tenant_configurations
CREATE TABLE public.tenant_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    
    -- Configuraci√≥n Chatwoot
    chatwoot_account_id INTEGER UNIQUE NOT NULL,
    chatwoot_webhook_token TEXT NOT NULL,
    
    -- Configuraci√≥n WhatsApp Business
    whatsapp_config JSONB NOT NULL DEFAULT '{}', -- {business_token, phone_number_id, verify_token}
    
    -- Configuraci√≥n Email/SMTP
    email_config JSONB NOT NULL DEFAULT '{}', -- {smtp_host, smtp_user, smtp_pass, from_email}
    
    -- Configuraci√≥n IA
    ai_config JSONB NOT NULL DEFAULT '{}', -- {provider, api_key, model, custom_prompts}
    
    -- Configuraci√≥n RAG
    rag_config JSONB NOT NULL DEFAULT '{}', -- {vector_index_id, embedding_model, search_config}
    
    -- Variables de Workflow
    workflow_variables JSONB NOT NULL DEFAULT '{}', -- {brand_colors, business_hours, templates}
    
    -- Estado
    activo BOOLEAN DEFAULT true,
    configuracion_completa BOOLEAN DEFAULT false,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(concesionario_id)
);
```

### **2. M√ìDULO DE RECLAMOS** (ALTA PRIORIDAD)
Basado en los workflows de reclamos, faltan varias tablas cr√≠ticas:

```sql
-- TABLA FALTANTE: reclamos (tabla principal)
CREATE TABLE public.reclamos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    sucursal_id UUID REFERENCES public.sucursales(id) ON DELETE SET NULL,
    cliente_id UUID REFERENCES public.clientes(id) ON DELETE SET NULL,
    vehiculo_id UUID REFERENCES public.vehiculos(id) ON DELETE SET NULL,
    venta_id UUID REFERENCES public.ventas(id) ON DELETE SET NULL,
    servicio_id UUID REFERENCES public.servicios(id) ON DELETE SET NULL,
    
    -- Identificaci√≥n del reclamo
    numero_reclamo VARCHAR(50) UNIQUE NOT NULL, -- REC-2024-001
    categoria_id UUID REFERENCES public.categorias_reclamo(id),
    
    -- Datos del cliente (snapshot)
    cliente_nombre VARCHAR(255) NOT NULL,
    cliente_email VARCHAR(255),
    cliente_telefono VARCHAR(20) NOT NULL,
    cliente_rut VARCHAR(20),
    
    -- Contenido del reclamo
    titulo VARCHAR(500) NOT NULL,
    descripcion TEXT NOT NULL,
    canal_ingreso VARCHAR(30) NOT NULL, -- 'whatsapp', 'email', 'web', 'presencial'
    
    -- Clasificaci√≥n autom√°tica por IA
    clasificacion_ia JSONB DEFAULT '{}', -- Resultado del an√°lisis RAG
    sentimiento_analisis JSONB DEFAULT '{}', -- An√°lisis de sentimiento
    
    -- Estado y asignaci√≥n
    estado VARCHAR(20) DEFAULT 'nuevo' CHECK (estado IN ('nuevo', 'asignado', 'en_proceso', 'resuelto', 'cerrado')),
    prioridad VARCHAR(10) DEFAULT 'media' CHECK (prioridad IN ('baja', 'media', 'alta', 'critica')),
    urgencia VARCHAR(10) DEFAULT 'normal' CHECK (urgencia IN ('baja', 'normal', 'alta')),
    
    -- Asignaci√≥n
    asignado_a_user_id UUID REFERENCES public.usuarios(id),
    
    -- Black Alert (ley del consumidor)
    black_alert BOOLEAN DEFAULT false,
    
    -- Fechas de seguimiento
    fecha_limite_resolucion TIMESTAMP WITH TIME ZONE,
    fecha_primera_respuesta TIMESTAMP WITH TIME ZONE,
    fecha_resolucion TIMESTAMP WITH TIME ZONE,
    tiempo_resolucion_horas INTEGER,
    
    -- Satisfacci√≥n final
    satisfaccion_cliente INTEGER CHECK (satisfaccion_cliente >= 1 AND satisfaccion_cliente <= 10),
    comentario_satisfaccion TEXT,
    
    -- Compensaci√≥n
    es_fundado BOOLEAN,
    motivo_no_fundado TEXT,
    compensacion_ofrecida TEXT,
    valor_compensacion DECIMAL(10,2),
    
    -- Seguimiento
    requiere_seguimiento BOOLEAN DEFAULT false,
    es_publico BOOLEAN DEFAULT false,
    url_seguimiento TEXT,
    
    -- Metadatos
    tags TEXT[] DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    attachments TEXT[] DEFAULT '{}',
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- TABLA FALTANTE: categorias_reclamo
CREATE TABLE public.categorias_reclamo (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    
    nombre VARCHAR(255) NOT NULL,
    descripcion TEXT,
    color VARCHAR(7) DEFAULT '#6B7280', -- Color hex para UI
    icono VARCHAR(50), -- Nombre del icono
    
    -- Configuraci√≥n
    es_activa BOOLEAN DEFAULT true,
    orden INTEGER DEFAULT 1,
    tiempo_resolucion_estimado INTEGER, -- Horas
    requiere_escalamiento BOOLEAN DEFAULT false,
    nivel_prioridad VARCHAR(10) DEFAULT 'media',
    
    -- Automatizaci√≥n
    departamento_responsable VARCHAR(100),
    flujo_resolucion JSONB DEFAULT '{}',
    plantilla_respuesta TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(concesionario_id, nombre)
);

-- TABLA FALTANTE: seguimientos_reclamo (historial de modificaciones)
CREATE TABLE public.seguimientos_reclamo (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reclamo_id UUID NOT NULL REFERENCES public.reclamos(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.usuarios(id),
    
    tipo_seguimiento VARCHAR(30) NOT NULL, -- 'comentario', 'cambio_estado', 'asignacion', 'resolucion'
    titulo VARCHAR(255),
    descripcion TEXT,
    
    -- Visibilidad
    es_publico BOOLEAN DEFAULT false, -- Visible para el cliente
    es_respuesta_automatica BOOLEAN DEFAULT false,
    
    -- Cambios de estado
    estado_anterior VARCHAR(20),
    estado_nuevo VARCHAR(20),
    asignado_anterior VARCHAR(255),
    asignado_nuevo VARCHAR(255),
    
    -- Comunicaci√≥n
    canal_comunicacion VARCHAR(30), -- 'whatsapp', 'email', 'llamada', 'presencial'
    tiempo_dedicado_minutos INTEGER DEFAULT 0,
    
    -- Adjuntos y metadatos
    attachments TEXT[] DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    
    -- Notificaciones
    notificado_cliente BOOLEAN DEFAULT false,
    fecha_notificacion TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **3. SISTEMA RAG/CONOCIMIENTO** (ALTA PRIORIDAD)
Para el funcionamiento del RAG en reclamos:

```sql
-- TABLA FALTANTE: knowledge_base (base de conocimiento)
CREATE TABLE public.knowledge_base (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    
    -- Documento
    titulo VARCHAR(500) NOT NULL,
    contenido TEXT NOT NULL,
    resumen TEXT,
    
    -- Categorizaci√≥n
    categoria VARCHAR(100), -- 'politicas', 'procedimientos', 'faq', 'manuales'
    subcategoria VARCHAR(100),
    tags TEXT[] DEFAULT '{}',
    
    -- Vectorizaci√≥n
    embedding vector(768), -- Gemini Embedding 001
    embedding_model VARCHAR(50) DEFAULT 'gemini-embedding-001',
    
    -- Metadatos
    fuente_original TEXT, -- URL, archivo, etc.
    version VARCHAR(20) DEFAULT '1.0',
    idioma VARCHAR(5) DEFAULT 'es',
    
    -- Estado
    activo BOOLEAN DEFAULT true,
    publico BOOLEAN DEFAULT false, -- Visible para clientes
    
    -- Auditor√≠a
    created_by UUID REFERENCES public.usuarios(id),
    approved_by UUID REFERENCES public.usuarios(id),
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- √çndice para b√∫squeda vectorial
CREATE INDEX IF NOT EXISTS idx_knowledge_base_embedding 
ON public.knowledge_base USING ivfflat (embedding vector_cosine_ops);
```

### **4. CAMPA√ëAS DE MARKETING** (MEDIA PRIORIDAD)
Para los workflows de campa√±as:

```sql
-- TABLA FALTANTE: campa√±as
CREATE TABLE public.campa√±as (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    
    -- Informaci√≥n b√°sica
    nombre VARCHAR(255) NOT NULL,
    descripcion TEXT,
    tipo_campa√±a VARCHAR(50) NOT NULL, -- 'email', 'whatsapp', 'mixta'
    
    -- Segmentaci√≥n
    audiencia_filtros JSONB DEFAULT '{}', -- Filtros de segmentaci√≥n
    total_destinatarios INTEGER DEFAULT 0,
    
    -- Contenido
    mensaje_template TEXT,
    variables_personalizacion JSONB DEFAULT '{}',
    adjuntos TEXT[] DEFAULT '{}',
    
    -- Programaci√≥n
    fecha_inicio TIMESTAMP WITH TIME ZONE,
    fecha_fin TIMESTAMP WITH TIME ZONE,
    programada BOOLEAN DEFAULT false,
    
    -- Estado
    estado VARCHAR(20) DEFAULT 'borrador' CHECK (estado IN ('borrador', 'programada', 'enviando', 'completada', 'pausada', 'cancelada')),
    
    -- M√©tricas
    total_enviados INTEGER DEFAULT 0,
    total_entregados INTEGER DEFAULT 0,
    total_abiertos INTEGER DEFAULT 0,
    total_clicks INTEGER DEFAULT 0,
    total_respuestas INTEGER DEFAULT 0,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- TABLA FALTANTE: campa√±a_envios (tracking individual)
CREATE TABLE public.campa√±a_envios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campa√±a_id UUID NOT NULL REFERENCES public.campa√±as(id) ON DELETE CASCADE,
    destinatario_telefono VARCHAR(20),
    destinatario_email VARCHAR(255),
    destinatario_nombre VARCHAR(255),
    
    -- Estado del env√≠o
    estado VARCHAR(20) DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'enviado', 'entregado', 'error', 'rebotado')),
    canal_usado VARCHAR(20), -- 'whatsapp', 'email'
    
    -- Tracking
    fecha_envio TIMESTAMP WITH TIME ZONE,
    fecha_entrega TIMESTAMP WITH TIME ZONE,
    fecha_apertura TIMESTAMP WITH TIME ZONE,
    fecha_click TIMESTAMP WITH TIME ZONE,
    fecha_respuesta TIMESTAMP WITH TIME ZONE,
    
    -- Personalizaci√≥n
    mensaje_enviado TEXT,
    variables_aplicadas JSONB DEFAULT '{}',
    
    -- Errores
    error_detalle TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **5. M√âTRICAS Y DASHBOARDS** (MEDIA PRIORIDAD)

```sql
-- TABLA FALTANTE: dashboard_metrics (para caching de m√©tricas)
CREATE TABLE public.dashboard_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    concesionario_id UUID NOT NULL REFERENCES public.concesionarios(id) ON DELETE CASCADE,
    sucursal_id UUID REFERENCES public.sucursales(id),
    
    -- Identificaci√≥n de la m√©trica
    metric_name VARCHAR(100) NOT NULL, -- 'nps_promedio', 'leads_convertidos', etc.
    metric_category VARCHAR(50) NOT NULL, -- 'ventas', 'encuestas', 'reclamos', 'general'
    
    -- Valor y metadatos
    metric_value DECIMAL(10,2),
    metric_count INTEGER,
    metric_data JSONB DEFAULT '{}', -- Datos adicionales/desglose
    
    -- Per√≠odo
    period_type VARCHAR(20) NOT NULL, -- 'daily', 'weekly', 'monthly', 'yearly'
    period_date DATE NOT NULL,
    
    -- Cache
    calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(concesionario_id, metric_name, period_type, period_date, sucursal_id)
);
```

---

## üîó Conexiones Cr√≠ticas Faltantes

### **1. Conexi√≥n N8N ‚Üî Supabase**
Los workflows requieren estas configuraciones en `tenant_configurations`:

```javascript
// En cada workflow de N8N, necesitas:
const tenantConfig = await getTenantConfig(concesionario_id);
const supabaseConfig = {
  url: 'https://gdnlodwwmvbgayzzudiu.supabase.co',
  serviceKey: tenantConfig.supabase_service_key,
  anonKey: tenantConfig.supabase_anon_key
};
```

### **2. Conexi√≥n Chatwoot ‚Üî Tenant**
Cada mensaje de Chatwoot debe identificar el tenant:

```javascript
// En el webhook de Chatwoot
const chatbootAccountId = webhook.account.id;
const tenantConfig = await getTenantByChawootId(chatbootAccountId);
const concesionario_id = tenantConfig.concesionario_id;
```

### **3. RAG Pipeline**
Para el funcionamiento del RAG en reclamos:

```javascript
// Pipeline completo RAG
1. Recibir reclamo ‚Üí extraer concesionario_id
2. Generar embedding del reclamo con Gemini
3. Buscar en knowledge_base del tenant espec√≠fico
4. Construir prompt con contexto + reclamo original
5. Enviar a Gemini 2.5 Pro para an√°lisis
6. Guardar resultado en reclamos.clasificacion_ia
```

---

## üéØ Plan de Implementaci√≥n Recomendado

### **FASE 1: CR√çTICO (Esta semana)**
1. ‚úÖ Crear `tenant_configurations` - Base para todo el multitenant
2. ‚úÖ Crear tablas de reclamos (`reclamos`, `categorias_reclamo`, `seguimientos_reclamo`)
3. ‚úÖ Implementar RLS policies para todas las nuevas tablas

### **FASE 2: ALTA PRIORIDAD (Pr√≥xima semana)**
1. ‚úÖ Crear `knowledge_base` para RAG
2. ‚úÖ Configurar √≠ndices vectoriales
3. ‚úÖ Migrar configuraciones existentes a `tenant_configurations`

### **FASE 3: MEJORAS (Siguientes 2 semanas)**
1. ‚úÖ Implementar sistema de campa√±as
2. ‚úÖ Optimizar dashboard_metrics
3. ‚úÖ Agregar campos faltantes a tablas existentes

### **FASE 4: OPTIMIZACI√ìN**
1. ‚úÖ Indices de performance
2. ‚úÖ Funciones stored procedures
3. ‚úÖ Triggers de auditor√≠a

---

## üîß Comandos de Verificaci√≥n

```bash
# Verificar tablas existentes
curl -H "apikey: YOUR_ANON_KEY" \
"https://gdnlodwwmvbgayzzudiu.supabase.co/rest/v1/"

# Verificar configuraci√≥n de tenant
curl -H "apikey: YOUR_ANON_KEY" \
"https://gdnlodwwmvbgayzzudiu.supabase.co/rest/v1/tenant_configurations?limit=1"

# Verificar reclamos
curl -H "apikey: YOUR_ANON_KEY" \
"https://gdnlodwwmvbgayzzudiu.supabase.co/rest/v1/reclamos?limit=1"
```

---

## üìã Checklist de Funcionalidad

### **Leads y Ventas** ‚úÖ
- [x] Recepci√≥n WhatsApp ‚Üí An√°lisis IA ‚Üí Asignaci√≥n ‚Üí Notificaci√≥n
- [x] Scoring autom√°tico de leads
- [x] Gesti√≥n de cotizaciones
- [x] Seguimiento de ventas

### **Encuestas Post-Venta** ‚úÖ  
- [x] 3 canales (QR ‚Üí WhatsApp ‚Üí Llamada)
- [x] Filtrado de duplicados
- [x] Alertas por baja satisfacci√≥n

### **Encuestas de Ventas** ‚úÖ
- [x] Disparadas por estado de lead
- [x] Diferentes canales seg√∫n tipo
- [x] Tracking de satisfacci√≥n

### **Reclamos** ‚ùå (FALTA IMPLEMENTAR)
- [ ] Recepci√≥n multicanal
- [ ] An√°lisis RAG con IA
- [ ] Sistema de asignaci√≥n autom√°tica
- [ ] Black Alert automation
- [ ] Historial de seguimiento

### **Campa√±as** ‚ùå (FALTA IMPLEMENTAR)
- [ ] Segmentaci√≥n de audiencias
- [ ] Env√≠o masivo WhatsApp/Email
- [ ] Tracking de m√©tricas
- [ ] Automatizaci√≥n de secuencias

---

**üö® ACCI√ìN INMEDIATA REQUERIDA:**
1. Implementar `tenant_configurations` para habilitar multitenant completo
2. Crear sistema de reclamos completo
3. Configurar RAG pipeline para an√°lisis inteligente
4. Establecer conexiones N8N ‚Üî Supabase con configuraci√≥n por tenant
