{
  "name": "Agregador de Métricas de Encuestas",
  "description": "Workflow que calcula y agrega métricas de encuestas (origen, rendimiento de ejecutivos, NPS) para optimizar dashboards.",
  "tags": ["dashboard", "metrics", "surveys", "aggregation"],
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 4
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Ejecutar cada 4 horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 2.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Consulta para agregar métricas de encuestas de las últimas 24 horas\nSELECT \n    concesionario_id,\n    origen,\n    COUNT(*) as total_encuestas,\n    COALESCE(jsonb_agg(jsonb_build_object('ejecutivo_id', cc_agent_id, 'nombre', cc_agent_name, 'total', count)) FILTER (WHERE origen = 'Llamada'), '[]'::jsonb) as rendimiento_ejecutivos,\n    AVG(recomendacion) as nps_promedio,\n    AVG(satisfaccion) as satisfaccion_promedio\nFROM \n    encuestas_postventa\nWHERE \n    fecha_completado >= NOW() - INTERVAL '24 hours'\nGROUP BY \n    concesionario_id, origen;"
      },
      "id": "query-survey-metrics",
      "name": "Consultar Métricas de Encuestas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [470, 300]
    },
    {
      "parameters": {
  "jsCode": "// Procesa métricas agregadas desde la consulta y normaliza campos\nconst item = $input.first().json;\n\n// Estructura de salida esperada por el nodo de upsert\nconst salida = {\n  concesionario_id: item.concesionario_id,\n  periodo: '24h',\n  fecha_calculo: new Date().toISOString(),\n  total_qr: item.origen === 'QR' ? item.total_encuestas : 0,\n  total_whatsapp: item.origen === 'WhatsApp' ? item.total_encuestas : 0,\n  total_llamada: item.origen === 'Llamada' ? item.total_encuestas : 0,\n  total_general: item.total_encuestas,\n  rendimiento_ejecutivos: item.rendimiento_ejecutivos || [],\n  nps_general: item.nps_promedio ?? null,\n  satisfaccion_promedio: item.satisfaccion_promedio ?? null\n};\n\nreturn [{ json: salida }];"
      },
      "id": "process-metrics",
      "name": "Procesar Métricas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [690, 300]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "metricas_dashboard_encuestas",
        "conflictKey": "concesionario_id,periodo,fecha_calculo",
        "columns": "concesionario_id,periodo,fecha_calculo,total_qr,total_whatsapp,total_llamada,total_general,rendimiento_ejecutivos,nps_general,satisfaccion_promedio",
        "additionalFields": {
          "values": "={{ [$json.concesionario_id, $json.periodo, $json.fecha_calculo, $json.total_qr, $json.total_whatsapp, $json.total_llamada, $json.total_general, JSON.stringify($json.rendimiento_ejecutivos), $json.nps_general, $json.satisfaccion_promedio] }}"
        }
      },
      "id": "upsert-metrics",
      "name": "Guardar Métricas en BD",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [910, 300]
    }
  ],
  "connections": {
    "Ejecutar cada 4 horas": {
      "main": [
        [
          {
            "node": "Consultar Métricas de Encuestas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Métricas de Encuestas": {
      "main": [
        [
          {
            "node": "Procesar Métricas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Métricas": {
      "main": [
        [
          {
            "node": "Guardar Métricas en BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}