{
  "name": "Survey Call Center Assignment",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/survey/call-center-assignment",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Call Center Assignment Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300],
      "webhookId": "survey-call-center-assignment"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $vars.SUPABASE_URL }}/rest/v1/usuarios",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $vars.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.SUPABASE_SERVICE_KEY }}"
            }
          ]
        },
        "qs": {
          "parameters": [
            {
              "name": "concesionario_id",
              "value": "eq.{{ $json.tenant_id }}"
            },
            {
              "name": "rol",
              "value": "eq.Contact Center"
            },
            {
              "name": "activo",
              "value": "eq.true"
            },
            {
              "name": "select",
              "value": "id,nombre,email,telefono,sucursal_id"
            }
          ]
        }
      },
      "id": "get-call-center-agents",
      "name": "Get Call Center Agents",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "/*** SURVEY CALL CENTER ASSIGNMENT - SRP: Solo asignación equitativa ***/\nconst assignmentData = $('Call Center Assignment Trigger').first().json;\nconst callCenterAgents = $('Get Call Center Agents').first().json;\nconst clientsToAssign = assignmentData.clients_for_call_center;\n\n
      },  
      "id": "assign-clients",
      "name": "Assign Clients",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "fieldToSplitOut": "assignments_by_agent",
        "options": {}
      },
      "id": "split-by-agent",
      "name": "Split By Agent",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.SUPABASE_URL }}/rest/v1/survey_call_assignments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $vars.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "concesionario_id",
              "value": "={{ $('Assign Clients').first().json.tenant_id }}"
            },
            {
              "name": "agente_id",
              "value": "={{ $json.agent_info.id }}"
            },
            {
              "name": "agente_nombre",
              "value": "={{ $json.agent_info.nombre }}"
            },
            {
              "name": "assigned_clients",
              "value": "={{ JSON.stringify($json.assigned_clients) }}"
            },
            {
              "name": "total_clients",
              "value": "={{ $json.assigned_clients.length }}"
            },
            {
              "name": "estado",
              "value": "pendiente"
            },
            {
              "name": "fecha_asignacion",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "name": "prioridad_alta_count",
              "value": "={{ $json.assigned_clients.filter(c => c.prioridad === 'alta').length }}"
            }
          ]
        }
      },
      "id": "register-assignments",
      "name": "Register Assignments",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "prepare-notification",
      "name": "Prepare Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.N8N_WEBHOOK_URL }}/webhook/send-email",
        "headers": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.N8N_WEBHOOK_AUTH_TOKEN }}"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "html",
              "value": "={{ $json.html }}"
            },
            {
              "name": "tenant_id",
              "value": "={{ $('Assign Clients').first().json.tenant_id }}"
            }
          ]
        }
      },
      "id": "send-notification",
      "name": "Send Notification", 
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "generate-report",
      "name": "Generate Final Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Asignación a Contact Center completada exitosamente\",\n  \"assignment_data\": {\n    \"total_clients_assigned\": {{ $('Assign Clients').first().json.total_assignments }},\n    \"total_agents\": {{ $('Assign Clients').first().json.total_agents }},\n    \"notifications_sent\": {{ $json.notification_results.emails_sent }}\n  },\n  \"final_report\": {{ JSON.stringify($json) }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2.1,
      "position": [2000, 300]
    }
  ],
  "connections": {
    "Call Center Assignment Trigger": {
      "main": [
        [
          {
            "node": "Get Call Center Agents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Call Center Agents": {
      "main": [
        [
          {
            "node": "Assign Clients",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assign Clients": {
      "main": [
        [
          {
            "node": "Split By Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split By Agent": {
      "main": [
        [
          {
            "node": "Register Assignments",
            "type": "main", 
            "index": 0
          }
        ]
      ]
    },
    "Register Assignments": {
      "main": [
        [
          {
            "node": "Prepare Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Notification": {
      "main": [
        [
          {
            "node": "Send Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Notification": {
      "main": [
        [
          {
            "node": "Generate Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Report": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "srp",
      "name": "srp"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "survey",
      "name": "survey"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "assignment",
      "name": "assignment"
    }
  ],
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "survey-call-center-assignment",
  "versionId": "1.0.0"
}