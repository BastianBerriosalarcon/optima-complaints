{
  "name": "Sales Survey - Low Score Notifier",
  "description": "Envía notificaciones por email al jefe de ventas y gerencia cuando una encuesta de ventas tiene calificación baja (1-8) y crea un caso para seguimiento.",
  "tags": ["sales", "survey", "notification", "low-score", "ventas", "email", "case-management"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "sales-notification-trigger",
      "name": "Trigger Notificación Ventas",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "tenant-config-loader",
        "data": "={{ JSON.stringify({ \"concesionario_id\": $json.concesionario_id, \"config_type\": \"email_notifications\" }) }}"
      },
      "id": "load-tenant-config-sales",
      "name": "Cargar Config Concesionario Ventas",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 2.1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.id, u.email, u.nombre_completo, u.rol FROM usuarios u WHERE u.concesionario_id = $1 AND u.activo = true AND (u.rol IN ('jefe_ventas', 'encargado_calidad') OR u.id = $2)",
        "additionalFields": {
          "queryParameters": "={{ [$json.concesionario_id, $json.venta_info.asesor_ventas_id] }}"
        }
      },
      "id": "get-sales-recipients",
      "name": "Obtener Destinatarios Específicos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [680, 300]
    },
    {
      "parameters": {
      },
      "id": "prepare-sales-email-data",
      "name": "Preparar Datos Email Ventas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "generate-sales-email-html",
      "name": "Generar HTML Email Ventas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.recipients.map(r => r.email).join(',') }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "message": "={{ $json.html_content }}",
        "options": {
          "priority": "={{ $json.priority }}"
        }
      },
      "id": "send-sales-notification-email",
      "name": "Enviar Email Notificación Ventas",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "casos_feedback_ventas",
        "columns": "survey_id,concesionario_id,sucursal_id,asesor_ventas_id,jefe_ventas_id,encargado_calidad_id",
        "additionalFields": {
          "values": "={{ [$('Trigger Notificación Ventas').first().json.survey_id, $('Trigger Notificación Ventas').first().json.concesionario_id, $('Trigger Notificación Ventas').first().json.sucursal_id, $('Trigger Notificación Ventas').first().json.venta_info.asesor_ventas_id, $('Obtener Destinatarios Específicos').first().json.find(r => r.rol === 'jefe_ventas')?.id, $('Obtener Destinatarios Específicos').first().json.find(r => r.rol === 'encargado_calidad')?.id] }}"
        }
      },
      "id": "create-feedback-case",
      "name": "Crear Caso de Feedback",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [1560, 300]
    },
    {
      "parameters": {
      },
      "id": "log-sales-notification-sent",
      "name": "Log Notificación y Caso Creado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [1780, 300]
    }
  ],
  "connections": {
    "Trigger Notificación Ventas": {
      "main": [
        [
          {
            "node": "Cargar Config Concesionario Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cargar Config Concesionario Ventas": {
      "main": [
        [
          {
            "node": "Obtener Destinatarios Específicos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Destinatarios Específicos": {
      "main": [
        [
          {
            "node": "Preparar Datos Email Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Email Ventas": {
      "main": [
        [
          {
            "node": "Generar HTML Email Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar HTML Email Ventas": {
      "main": [
        [
          {
            "node": "Enviar Email Notificación Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Email Notificación Ventas": {
      "main": [
        [
          {
            "node": "Crear Caso de Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Caso de Feedback": {
      "main": [
        [
          {
            "node": "Log Notificación y Caso Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}