{
  "name": "Sales Survey - Response Handler",
  "description": "Maneja respuestas de encuestas de VENTAS, registra en tabla sales_surveys y dispara notificaciones al jefe de ventas.",
  "tags": ["sales", "survey", "response", "handler", "ventas"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "sales-workflow-trigger",
      "name": "Trigger del Workflow Ventas",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
      },
      "id": "validate-sales-survey-response",
      "name": "Validar Respuesta Encuesta Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO encuestas_ventas (concesionario_id, sucursal_id, cliente_nombre, cliente_rut, cliente_telefono, asesor_ventas_id, vehiculo_modelo, fecha_venta, experiencia_venta, satisfaccion_asesor_ventas, claridad_informacion, recomendacion_venta, comentario, origen, estado, average_score) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16) RETURNING *",
        "additionalFields": {
          "queryParameters": "={{ [$json.concesionario_id, $json.sucursal_id, $json.cliente_nombre, $json.cliente_rut, $json.cliente_telefono, $json.asesor_ventas_id, $json.vehiculo_modelo, $json.fecha_venta, $json.experiencia_venta, $json.satisfaccion_asesor_ventas, $json.claridad_informacion, $json.recomendacion_venta, $json.comentario, $json.origen, $json.estado, $json.average_score] }}"
        }
      },
      "id": "insert-sales-survey-response",
      "name": "Registrar Encuesta Ventas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('Validar Respuesta Encuesta Ventas').first().json.requires_notification }}",
              "operation": "equal",
              "value2": true
            }
          ]
        }
      },
      "id": "check-notification-required-sales",
      "name": "¿Requiere Notificación Ventas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
      },
      "id": "prepare-sales-notification-data",
      "name": "Preparar Datos Notificación Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "sales-survey-low-score-notifier",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-sales-low-score-notification",
      "name": "Disparar Notificación Baja Calificación Ventas",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [1340, 200]
    },
    {
      "parameters": {
      },
      "id": "generate-sales-success-response",
      "name": "Generar Respuesta Éxito Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 400]
    }
  ],
  "connections": {
    "Trigger del Workflow Ventas": {
      "main": [
        [
          {
            "node": "Validar Respuesta Encuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Respuesta Encuesta Ventas": {
      "main": [
        [
          {
            "node": "Registrar Encuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Encuesta Ventas": {
      "main": [
        [
          {
            "node": "¿Requiere Notificación Ventas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Notificación Ventas?": {
      "main": [
        [
          {
            "node": "Preparar Datos Notificación Ventas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generar Respuesta Éxito Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Notificación Ventas": {
      "main": [
        [
          {
            "node": "Disparar Notificación Baja Calificación Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Disparar Notificación Baja Calificación Ventas": {
      "main": [
        [
          {
            "node": "Generar Respuesta Éxito Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}