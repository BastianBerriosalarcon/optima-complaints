{
  "name": "Sales Survey - WhatsApp Bulk Sender",
  "description": "Envía encuestas de ventas masivamente por WhatsApp después de carga de Excel",
  "tags": ["sales", "survey", "whatsapp", "bulk", "ventas", "masivo"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "sales-survey-bulk-trigger",
      "name": "Trigger de Encuestas Masivas Ventas",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
      },
      "id": "process-sales-bulk-data",
      "name": "Procesar Lote Encuestas Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT wc.whatsapp_token, wc.phone_number_id, wc.business_name, c.nombre as concesionario_nombre FROM tenant_configurations tc JOIN concesionarios c ON tc.tenant_id = c.id WHERE tc.tenant_id = $1",
        "additionalFields": {
          "queryParameters": "={{ [$json.concesionario_id] }}"
        }
      },
      "id": "get-whatsapp-config-sales",
      "name": "Obtener Config WhatsApp Ventas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
      },
      "id": "generate-sales-whatsapp-message",
      "name": "Generar Mensaje WhatsApp Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/{{ $json.phone_number_id }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "whatsapp"
            },
            {
              "name": "to",
              "value": "={{ $json.to_phone }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "text",
              "value": "={{ { object: $json.message_text } }}"
            }
          ]
        }
      },
      "id": "send-whatsapp-sales-survey",
      "name": "Enviar WhatsApp Encuesta Ventas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE encuestas_ventas SET estado = 'enviado_whatsapp', fecha_ultimo_contacto = NOW(), intentos_contacto = 1 WHERE concesionario_id = $1 AND cliente_telefono = $2 AND vehiculo_modelo = $3 AND fecha_venta = $4",
        "additionalFields": {
          "queryParameters": "={{ [$('Procesar Lote Encuestas Ventas').first().json.concesionario_id, $('Procesar Lote Encuestas Ventas').first().json.cliente_telefono, $('Procesar Lote Encuestas Ventas').first().json.vehiculo_modelo, $('Procesar Lote Encuestas Ventas').first().json.fecha_venta] }}"
        }
      },
      "id": "update-sales-survey-status",
      "name": "Actualizar Estado Encuesta Ventas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
      },
      "id": "generate-sales-bulk-report",
      "name": "Generar Reporte Envío Ventas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 300]
    }
  ],
  "connections": {
    "Trigger de Encuestas Masivas Ventas": {
      "main": [
        [
          {
            "node": "Procesar Lote Encuestas Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Lote Encuestas Ventas": {
      "main": [
        [
          {
            "node": "Obtener Config WhatsApp Ventas",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generar Mensaje WhatsApp Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Config WhatsApp Ventas": {
      "main": [
        [
          {
            "node": "Generar Mensaje WhatsApp Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Mensaje WhatsApp Ventas": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp Encuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp Encuesta Ventas": {
      "main": [
        [
          {
            "node": "Actualizar Estado Encuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Estado Encuesta Ventas": {
      "main": [
        [
          {
            "node": "Generar Reporte Envío Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}