{
  "name": "encuestas-ventas-whatsapp-automatico",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 10 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Disparador Diario",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "select",
        "table": "leads",
        "where": "estado = 'vendido' AND fecha_cierre >= CURRENT_DATE - INTERVAL '1 day' AND fecha_cierre < CURRENT_DATE",
        "sort": "fecha_cierre DESC"
      },
      "id": "get-sold-leads",
      "name": "Obtener Leads Vendidos Ayer",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [460, 300],
      "credentials": {
        "supabaseApi": {
          "id": "tenant-supabase-{{$workflow.settings.tenant_id}}",
          "name": "Supabase {{$workflow.settings.tenant_name}}"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Filtrar leads que ya no tienen encuesta de ventas\nconst leads = $input.all()[0].json;\n\nif (!leads || leads.length === 0) {\n  console.log('No hay leads vendidos ayer');\n  return [];\n}\n\n// Preparar consulta para verificar encuestas existentes\nconst phoneNumbers = leads.map(lead => lead.telefono_cliente);\n\nreturn [{\n  json: {\n    leads: leads,\n    phone_numbers: phoneNumbers,\n    count: leads.length\n  }\n}];"
      },
      "id": "prepare-filter",
      "name": "Preparar Filtro",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "select",
        "table": "encuestas_ventas",
        "where": "cliente_telefono IN ('{{ $json.phone_numbers.join(\"','\") }}') AND fecha_venta >= CURRENT_DATE - INTERVAL '2 days'",
        "sort": "created_at DESC"
      },
      "id": "check-existing-surveys",
      "name": "Verificar Encuestas Existentes",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [900, 300],
      "credentials": {
        "supabaseApi": {
          "id": "tenant-supabase-{{$workflow.settings.tenant_id}}",
          "name": "Supabase {{$workflow.settings.tenant_name}}"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Filtrar leads que NO tienen encuesta de ventas\nconst leadsData = $('Preparar Filtro').first().json;\nconst existingSurveys = $input.all()[0].json || [];\n\nconst leads = leadsData.leads;\nconst existingPhones = new Set(existingSurveys.map(s => s.cliente_telefono));\n\n// Filtrar leads sin encuesta\nconst leadsToSurvey = leads.filter(lead => !existingPhones.has(lead.telefono_cliente));\n\nconsole.log(`Leads vendidos: ${leads.length}, Ya tienen encuesta: ${existingSurveys.length}, Pendientes: ${leadsToSurvey.length}`);\n\nif (leadsToSurvey.length === 0) {\n  return [];\n}\n\n// Crear encuestas pendientes en batch\nconst surveyData = leadsToSurvey.map(lead => ({\n  concesionario_id: lead.concesionario_id,\n  sucursal_id: lead.sucursal_id || null,\n  lead_id: lead.id,\n  asesor_ventas_id: lead.asesor_asignado_id,\n  cliente_nombre: lead.nombre_cliente,\n  cliente_telefono: lead.telefono_cliente,\n  cliente_email: lead.email_cliente,\n  vehiculo_modelo: lead.modelo_interes || 'VehÃ­culo',\n  fecha_venta: lead.fecha_cierre ? lead.fecha_cierre.split('T')[0] : new Date().toISOString().split('T')[0],\n  origen: 'WhatsApp_VENTAS',\n  estado: 'pendiente'\n}));\n\nreturn surveyData.map(survey => ({ json: survey }));"
      },
      "id": "filter-and-create-surveys",
      "name": "Filtrar y Crear Encuestas",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "insert",
        "table": "encuestas_ventas",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "concesionario_id": "={{ $json.concesionario_id }}",
            "sucursal_id": "={{ $json.sucursal_id }}",
            "lead_id": "={{ $json.lead_id }}",
            "asesor_ventas_id": "={{ $json.asesor_ventas_id }}",
            "cliente_nombre": "={{ $json.cliente_nombre }}",
            "cliente_telefono": "={{ $json.cliente_telefono }}",
            "cliente_email": "={{ $json.cliente_email }}",
            "vehiculo_modelo": "={{ $json.vehiculo_modelo }}",
            "fecha_venta": "={{ $json.fecha_venta }}",
            "origen": "={{ $json.origen }}",
            "estado": "={{ $json.estado }}"
          }
        }
      },
      "id": "create-pending-survey",
      "name": "Crear Encuesta Pendiente",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1340, 300],
      "credentials": {
        "supabaseApi": {
          "id": "tenant-supabase-{{$workflow.settings.tenant_id}}",
          "name": "Supabase {{$workflow.settings.tenant_name}}"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Preparar mensaje WhatsApp personalizado\nconst survey = $input.all()[0].json;\nconst tenantConfig = $workflow.settings.tenant_config || {};\n\n// Personalizar mensaje segÃºn configuraciÃ³n del tenant\nconst brandName = tenantConfig.nombre || 'Concesionario';\nconst surveyUrl = `${$workflow.settings.frontend_url}/encuesta-ventas/${survey.id}`;\n\nconst message = `ðŸš— Â¡Hola ${survey.cliente_nombre}!\n\nEsperamos que estÃ© disfrutando su nuevo ${survey.vehiculo_modelo}.\n\nNos gustarÃ­a conocer su experiencia durante el proceso de compra para seguir mejorando nuestro servicio.\n\nÂ¿PodrÃ­a tomarse 2 minutos para completar esta breve encuesta?\nðŸ‘† ${surveyUrl}\n\nÂ¡Gracias por elegirnos!\n*${brandName}*`;\n\nreturn [{\n  json: {\n    phone: survey.cliente_telefono,\n    message: message,\n    survey_id: survey.id,\n    tenant_id: survey.concesionario_id,\n    template_type: 'encuesta_ventas_whatsapp'\n  }\n}];"
      },
      "id": "prepare-whatsapp-message",
      "name": "Preparar Mensaje WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "url": "={{ $workflow.settings.whatsapp_webhook_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $workflow.settings.tenant_config.whatsapp.access_token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "whatsapp"
            },
            {
              "name": "to",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "text",
              "value": "={{ JSON.stringify({body: $json.message}) }}"
            }
          ]
        }
      },
      "id": "send-whatsapp",
      "name": "Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "update",
        "table": "encuestas_ventas",
        "filterColumn": "id",
        "filterValue": "={{ $('Crear Encuesta Pendiente').first().json.id }}",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "whatsapp_enviado": "true",
            "fecha_envio_whatsapp": "={{ new Date().toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          }
        }
      },
      "id": "update-survey-sent",
      "name": "Marcar WhatsApp Enviado",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2000, 300],
      "credentials": {
        "supabaseApi": {
          "id": "tenant-supabase-{{$workflow.settings.tenant_id}}",
          "name": "Supabase {{$workflow.settings.tenant_name}}"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Disparador Diario": {
      "main": [
        [
          {
            "node": "Obtener Leads Vendidos Ayer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Leads Vendidos Ayer": {
      "main": [
        [
          {
            "node": "Preparar Filtro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Filtro": {
      "main": [
        [
          {
            "node": "Verificar Encuestas Existentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Encuestas Existentes": {
      "main": [
        [
          {
            "node": "Filtrar y Crear Encuestas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar y Crear Encuestas": {
      "main": [
        [
          {
            "node": "Crear Encuesta Pendiente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Encuesta Pendiente": {
      "main": [
        [
          {
            "node": "Preparar Mensaje WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensaje WhatsApp": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "Marcar WhatsApp Enviado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "error-handler-workflow"
  },
  "versionId": "1",
  "meta": {
    "templateCreatedBy": "optimacx-platform",
    "description": "EnvÃ­a automÃ¡ticamente encuestas de ventas por WhatsApp a leads vendidos el dÃ­a anterior. Filtra duplicados y personaliza mensajes por tenant.",
    "tags": ["ventas", "encuestas", "whatsapp", "automatizacion", "multitenant"]
  }
}
