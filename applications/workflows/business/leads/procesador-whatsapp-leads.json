{
  "meta": {
    "instanceId": "proc-whatsapp-leads-001"
  },
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "proceso-whatsapp-leads",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "whatsapp-leads-processor"
    },
    {
      "parameters": {
        "jsCode": "// Procesar mensaje entrante de WhatsApp para leads\nconst webhookData = $input.first().json;\nconst body = webhookData.body || webhookData;\n\n// Extraer información del mensaje\nconst message = {\n  phone: body.from || body.phone_number,\n  text: body.text || body.message || '',\n  timestamp: body.timestamp || new Date().toISOString(),\n  contact_name: body.profile?.name || body.contact_name || 'Cliente',\n  message_id: body.id || body.message_id || `msg_${Date.now()}`\n};\n\n// Validar que sea un lead potencial\nconst esLeadPotencial = {\n  tiene_telefono: !!message.phone,\n  tiene_mensaje: message.text.length > 10,\n  palabras_clave: /cotiz|precio|costo|vehículo|auto|compra|financ|crédito/i.test(message.text),\n  no_es_spam: !/spam|test|prueba/i.test(message.text)\n};\n\nconst esValido = Object.values(esLeadPotencial).every(v => v === true);\n\n// Extraer información del lead\nconst leadData = {\n  telefono: message.phone,\n  nombre: message.contact_name,\n  mensaje_inicial: message.text,\n  canal_origen: 'WhatsApp',\n  fecha_contacto: message.timestamp,\n  estado: 'nuevo',\n  prioridad: esLeadPotencial.palabras_clave ? 'alta' : 'media',\n  metadata: {\n    message_id: message.message_id,\n    validacion: esLeadPotencial,\n    es_valido: esValido\n  }\n};\n\nreturn [{ json: leadData }];"
      },
      "id": "process-message",
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "es-lead-valido",
              "leftValue": "={{ $json.metadata.es_valido }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "validate-lead",
      "name": "¿Es Lead Válido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $json.telefono }}",
            "nombre": "={{ $json.nombre }}",
            "mensaje_inicial": "={{ $json.mensaje_inicial }}",
            "canal_origen": "={{ $json.canal_origen }}",
            "fecha_contacto": "={{ $json.fecha_contacto }}",
            "estado": "={{ $json.estado }}",
            "prioridad": "={{ $json.prioridad }}",
            "metadata": "={{ JSON.stringify($json.metadata) }}"
          }
        },
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "insert-lead",
      "name": "Guardar Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [900, 200],
      "credentials": {
        "postgres": {
          "id": "supabase-main",
          "name": "Supabase Main DB"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('webhook-trigger').first().json.headers['x-callback-url'] || 'https://api.optimacx.com/leads/assign' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-API-Key",
              "value": "={{ $vars.OPTIMACX_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "lead_id",
              "value": "={{ $json.id }}"
            },
            {
              "name": "telefono",
              "value": "={{ $json.telefono }}"
            },
            {
              "name": "prioridad",
              "value": "={{ $json.prioridad }}"
            }
          ]
        },
        "options": {}
      },
      "id": "trigger-assignment",
      "name": "Activar Asignación",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.whatsapp.com/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.WHATSAPP_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.telefono }}"
            },
            {
              "name": "text",
              "value": "¡Hola {{ $json.nombre }}! 👋 Gracias por contactarnos. Hemos recibido tu consulta y uno de nuestros asesores se pondrá en contacto contigo pronto. ¿En qué vehículo estás interesado?"
            }
          ]
        },
        "options": {}
      },
      "id": "send-confirmation",
      "name": "Enviar Confirmación",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Lead procesado y guardado\",\n  \"lead_id\": \"{{ $('Guardar Lead').first().json.id }}\",\n  \"phone\": \"{{ $json.telefono }}\",\n  \"priority\": \"{{ $json.prioridad }}\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "success-response",
      "name": "Respuesta Éxito",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2.1,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"rejected\",\n  \"message\": \"Mensaje no válido para lead\",\n  \"phone\": \"{{ $json.telefono }}\",\n  \"validation_failed\": {{ JSON.stringify($json.metadata.validacion) }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "reject-response",
      "name": "Respuesta Rechazo",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2.1,
      "position": [900, 500]
    }
  ],
  "connections": {
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Procesar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Mensaje": {
      "main": [
        [
          {
            "node": "¿Es Lead Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Lead Válido?": {
      "main": [
        [
          {
            "node": "Guardar Lead",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar Confirmación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta Rechazo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Lead": {
      "main": [
        [
          {
            "node": "Activar Asignación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Activar Asignación": {
      "main": [
        [
          {
            "node": "Respuesta Éxito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["leads", "whatsapp", "procesamiento"],
  "triggerCount": 0,
  "updatedAt": "2024-08-09T05:47:00.000Z",
  "versionId": "proc-whatsapp-leads-v2.1",
  "name": "Procesador WhatsApp Leads",
  "active": true,
  "id": "proc-whatsapp-leads",
  "hash": "whatsapp-leads-processor"
}
