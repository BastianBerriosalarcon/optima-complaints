{
  "name": "Lead - Asignaci√≥n y Notificaciones",
  "description": "Asigna un lead a un asesor, y notifica al asesor, al jefe de ventas y al cliente.",
  "tags": ["assignment", "notification", "srp"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "workflow-trigger",
      "name": "Trigger del Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, nombre, email, especialidad, carga_actual FROM usuarios WHERE concesionario_id = $1 AND rol = 'asesor_ventas' AND activo = true",
        "additionalFields": {
          "queryParameters": "={{ [$json.tenant_config.tenant_id] }}"
        }
      },
      "id": "get-available-advisors",
      "name": "Obtener Asesores Disponibles",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [420, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, nombre, email FROM usuarios WHERE concesionario_id = $1 AND rol = 'jefe_de_ventas' AND activo = true LIMIT 1",
        "additionalFields": {
          "queryParameters": "={{ [$json.tenant_config.tenant_id] }}"
        }
      },
      "id": "get-sales-manager",
      "name": "Obtener Jefe de Ventas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [420, 400]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "assign-advisor-and-prep-data",
      "name": "Asignar Asesor y Preparar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "prepare-advisor-notification",
      "name": "Preparar Email Asesor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 200]
    },
    {
      "parameters": {
      },
      "id": "prepare-manager-notification",
      "name": "Preparar Email Jefe de Ventas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.N8N_WEBHOOK_URL }}/webhook/send-email", 
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "html",
              "value": "={{ $json.html }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-advisor-email",
      "name": "Enviar Email Asesor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1080, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.N8N_WEBHOOK_URL }}/webhook/send-email",
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "html",
              "value": "={{ $json.html }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-manager-email",
      "name": "Enviar Email Jefe de Ventas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1080, 400]
    }
  ],
  "connections": {
    "Trigger del Workflow": {
      "main": [
        [
          {
            "node": "Obtener Asesores Disponibles",
            "type": "main",
            "index": 0
          },
          {
            "node": "Obtener Jefe de Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Asesores Disponibles": {
      "main": [
        [
          {
            "node": "Asignar Asesor y Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Jefe de Ventas": {
      "main": [
        [
          {
            "node": "Asignar Asesor y Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Asignar Asesor y Preparar Datos": {
      "main": [
        [
          {
            "node": "Preparar Email Asesor",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Email Jefe de Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Email Asesor": {
      "main": [
        [
          {
            "node": "Enviar Email Asesor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Email Jefe de Ventas": {
      "main": [
        [
          {
            "node": "Enviar Email Jefe de Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}