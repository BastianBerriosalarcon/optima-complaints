{
  "name": "Lead - Gestión y Persistencia",
  "description": "Workflow enfocado en crear/actualizar leads y persistir información en base de datos",
  "tags": ["lead", "database", "crud", "srp"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "workflow-trigger",
      "name": "Trigger del Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.context.has_existing_lead }}",
              "operation": "equal",
              "value2": true
            }
          ]
        }
      },
      "id": "is-existing-lead",
      "name": "¿Lead Existente?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "functionCode": "
  estado: estadoMap[analysis.intencion] || 'nuevo',
  origen: 'whatsapp',
  intencion_detectada: analysis.intencion,
  nivel_interes: analysis.nivel_interes,
      },
      "id": "prepare-new-lead",
      "name": "Preparar Nuevo Lead",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [600, 240]
    },
    {
      "parameters": {
        "functionCode": "
  nivel_interes: analysis.nivel_interes,
      },
      "id": "prepare-update-lead",
      "name": "Preparar Actualización Lead",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [600, 360]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "leads",
        "columns": "concesionario_id, telefono_cliente, nombre_cliente, email_cliente, estado, origen, intencion_detectada, nivel_interes, lead_score, vehiculo_interes, presupuesto_estimado, notas_ia, metadata",
        "additionalFields": {
          "values": "={{ [$json.concesionario_id, $json.telefono_cliente, $json.nombre_cliente, $json.email_cliente, $json.estado, $json.origen, $json.intencion_detectada, $json.nivel_interes, $json.lead_score, JSON.stringify($json.vehiculo_interes), $json.presupuesto_estimado, $json.notas_ia, JSON.stringify($json.metadata)] }}"
        }
      },
      "id": "create-lead",
      "name": "Crear Lead en BD",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [800, 240]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE leads SET nombre_cliente = COALESCE($2, nombre_cliente), email_cliente = COALESCE($3, email_cliente), nivel_interes = $4, lead_score = $5, vehiculo_interes = COALESCE($6::jsonb, vehiculo_interes), presupuesto_estimado = COALESCE($7, presupuesto_estimado), notas_ia = CONCAT(notas_ia, '\n', $8), metadata = metadata || $9::jsonb, updated_at = NOW() WHERE id = $1 RETURNING *",
        "additionalFields": {
          "queryParameters": "={{ [$json.lead_id, $json.nombre_cliente, $json.email_cliente, $json.nivel_interes, $json.lead_score, JSON.stringify($json.vehiculo_interes), $json.presupuesto_estimado, $json.nueva_nota, JSON.stringify($json.metadata_update)] }}"
        }
      },
      "id": "update-lead",
      "name": "Actualizar Lead en BD",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [800, 360]
    },
    {
      "parameters": {
      },
      "id": "format-success-response",
      "name": "Formatear Respuesta",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO audit_log (entity_type, entity_id, action, tenant_id, user_id, changes, metadata, created_at) VALUES ('lead', $1, $2, $3, 'system', $4, $5, NOW())",
        "additionalFields": {
          "queryParameters": "={{ [$json.lead_id, $json.operation, $json.processing.tenant_id, JSON.stringify($json.lead_data), JSON.stringify($json.processing)] }}"
        }
      },
      "id": "log-audit",
      "name": "Registrar Auditoría",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.next_step.workflow }}",
              "operation": "equal",
              "value2": "advisor-assignment"
            }
          ]
        }
      },
      "id": "check-next-workflow",
      "name": "¿Requiere Asesor?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "lead-notifications-workflow",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-advisor-workflow",
      "name": "Activar Asignación Asesor",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [1600, 260]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "automated-response-workflow",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-response-workflow",
      "name": "Activar Respuesta Automática",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [1600, 340]
    }
  ],
  "connections": {
    "Trigger del Workflow": {
      "main": [
        [
          {
            "node": "¿Lead Existente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Lead Existente?": {
      "main": [
        [
          {
            "node": "Preparar Actualización Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Nuevo Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Nuevo Lead": {
      "main": [
        [
          {
            "node": "Crear Lead en BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Actualización Lead": {
      "main": [
        [
          {
            "node": "Actualizar Lead en BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Lead en BD": {
      "main": [
        [
          {
            "node": "Formatear Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Lead en BD": {
      "main": [
        [
          {
            "node": "Formatear Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta": {
      "main": [
        [
          {
            "node": "Registrar Auditoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Auditoría": {
      "main": [
        [
          {
            "node": "¿Requiere Asesor?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Asesor?": {
      "main": [
        [
          {
            "node": "Activar Asignación Asesor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Activar Respuesta Automática",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}