{
  "name": "Agregador de Métricas de Reclamos",
  "description": "Workflow que calcula y agrega métricas de reclamos (estado, tipo, sucursal, tiempos) para optimizar dashboards.",
  "tags": ["dashboard", "metrics", "complaints", "aggregation"],
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 4
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Ejecutar cada 4 horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 2.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Consulta para agregar métricas de reclamos de las últimas 24 horas\nSELECT \n    concesionario_id,\n    estado,\n    tipo_reclamo,\n    sucursal,\n    COUNT(*) as total_reclamos,\n    AVG(EXTRACT(EPOCH FROM (fecha_cierre - fecha_creacion))/3600) as tiempo_resolucion_horas,\n    COUNT(*) FILTER (WHERE black_alert = true) as total_black_alerts\nFROM \n    reclamos\nWHERE \n    fecha_creacion >= NOW() - INTERVAL '24 hours'\nGROUP BY \n    concesionario_id, estado, tipo_reclamo, sucursal;"
      },
      "id": "query-complaint-metrics",
      "name": "Consultar Métricas de Reclamos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [470, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "process-metrics",
      "name": "Procesar Métricas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [690, 300]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "metricas_dashboard_reclamos",
        "conflictKey": "concesionario_id,periodo,fecha_calculo",
        "columns": "concesionario_id,periodo,fecha_calculo,total_pendientes,total_en_proceso,total_cerrados,total_reclamos,distribucion_por_tipo,distribucion_por_sucursal,tiempo_resolucion_promedio_horas,total_black_alerts",
        "additionalFields": {
          "values": "={{ [$json.concesionario_id, $json.periodo, $json.fecha_calculo, $json.total_pendientes, $json.total_en_proceso, $json.total_cerrados, $json.total_reclamos, JSON.stringify($json.distribucion_por_tipo), JSON.stringify($json.distribucion_por_sucursal), $json.tiempo_resolucion_promedio_horas, $json.total_black_alerts] }}"
        }
      },
      "id": "upsert-metrics",
      "name": "Guardar Métricas en BD",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [910, 300]
    }
  ],
  "connections": {
    "Ejecutar cada 4 horas": {
      "main": [
        [
          {
            "node": "Consultar Métricas de Reclamos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Métricas de Reclamos": {
      "main": [
        [
          {
            "node": "Procesar Métricas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Métricas": {
      "main": [
        [
          {
            "node": "Guardar Métricas en BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}