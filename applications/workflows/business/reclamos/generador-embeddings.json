{
  "name": "Knowledge - Embedding Generation",
  "description": "Workflow enfocado en generar embeddings para chunks de documentos. Principio SRP: Una sola responsabilidad - embeddings.",
  "tags": ["rag", "knowledge", "embedding", "srp"],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "workflow-trigger",
      "name": "Trigger del Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
      },
      "id": "prepare-embedding-batches",
      "name": "Preparar Lotes Embedding",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "split-into-batches",
      "name": "Dividir en Lotes",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
      },
      "id": "process-current-batch",
      "name": "Procesar Lote Actual",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "x-goog-api-key",
              "value": "={{ $vars.GEMINI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "content",
              "value": "={\n  \"parts\": [\n    {\n      \"text\": \"{{ $json.text_to_embed }}\"\n    }\n  ]\n}"
            },
            {
              "name": "taskType",
              "value": "RETRIEVAL_DOCUMENT"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          }
        }
      },
      "id": "generate-gemini-embeddings",
      "name": "Generar Embeddings Gemini",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
      },
      "id": "combine-embeddings-results",
      "name": "Combinar Resultados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "knowledge-storage",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-storage-workflow",
      "name": "Iniciar Almacenamiento",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 2.1,
      "position": [1560, 300]
    }
  ],
  "connections": {
    "Trigger del Workflow": {
      "main": [
        [
          {
            "node": "Preparar Lotes Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Lotes Embedding": {
      "main": [
        [
          {
            "node": "Dividir en Lotes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir en Lotes": {
      "main": [
        [
          {
            "node": "Procesar Lote Actual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Lote Actual": {
      "main": [
        [
          {
            "node": "Generar Embeddings Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Embeddings Gemini": {
      "main": [
        [
          {
            "node": "Combinar Resultados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Resultados": {
      "main": [
        [
          {
            "node": "Iniciar Almacenamiento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}