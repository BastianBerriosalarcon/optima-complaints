{
  "name": "ReRank Cohere - Refinamiento de Documentos RAG",
  "description": "Workflow que utiliza la API de Cohere Rerank para mejorar significativamente la precisión de documentos recuperados en el pipeline RAG, proporcionando contexto de alta calidad al LLM.",
  "tags": [
    "rag",
    "cohere", 
    "rerank",
    "documentos",
    "precision",
    "critico"
  ],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "workflow-trigger",
      "name": "Trigger ReRank",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {
      },
      "id": "validate-rerank-input",
      "name": "Validar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Obtener configuración de Cohere para el tenant\nSELECT \n  configuracion_ai->>'cohere_api_key' as cohere_api_key,\n  configuracion_ai->>'cohere_model' as cohere_model,\n  configuracion_ai->>'rerank_top_k' as rerank_top_k,\n  configuracion_ai->>'rerank_threshold' as rerank_threshold\nFROM concesionarios \nWHERE id = $1 AND activo = true\nLIMIT 1;",
        "additionalFields": {
          "queryParameters": "=[$json.tenant_id]"
        }
      },
      "id": "get-cohere-config",
      "name": "Obtener Config Cohere",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [690, 300]
    },
    {
      "parameters": {
      },
      "id": "prepare-cohere-request",
      "name": "Preparar Request Cohere",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [910, 300]
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "requestMethod": "POST",
        "url": "https:
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.cohere_config.api_key }}"
            },
            {
              "name": "Content-Type", 
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={{ JSON.stringify($json.cohere_request) }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxRetries": 2
          },
          "response": {
            "response": {
              "fullResponse": false,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "call-cohere-rerank",
      "name": "Llamar Cohere Rerank",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.2,
      "position": [1130, 300]
    },
    {
      "parameters": {
      },
      "id": "process-rerank-results",
      "name": "Procesar Resultados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1350, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Registrar métricas de reranking para análisis posterior\nINSERT INTO rag_rerank_metrics (\n  tenant_id,\n  query_hash,\n  original_documents_count,\n  reranked_documents_count,\n  filtered_documents_count,\n  threshold_used,\n  average_relevance_score,\n  top_relevance_score,\n  significant_improvements_count,\n  model_used,\n  processing_time_ms,\n  created_at\n) VALUES (\n  $1,\n  encode(sha256($2::bytea), 'hex'),\n  $3,\n  $4, \n  $5,\n  $6,\n  $7,\n  $8,\n  $9,\n  $10,\n  $11,\n  CURRENT_TIMESTAMP\n) \nON CONFLICT (tenant_id, query_hash) DO UPDATE SET\n  reranked_documents_count = EXCLUDED.reranked_documents_count,\n  filtered_documents_count = EXCLUDED.filtered_documents_count,\n  average_relevance_score = EXCLUDED.average_relevance_score,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
        "additionalFields": {
          "queryParameters": "=[\n  $json.tenant_id,\n  $json.query,\n  $json.rerank_stats.original_count,\n  $json.rerank_stats.reranked_count,\n  $json.rerank_stats.filtered_count,\n  $json.rerank_stats.threshold_used,\n  $json.rerank_stats.average_relevance_score,\n  $json.rerank_stats.top_score,\n  $json.rerank_stats.significant_improvements,\n  'rerank-multilingual-v3.0',\n  Math.round((new Date() - new Date($json.processing_completed_at)) / 1000 * 1000)\n]"
        }
      },
      "id": "log-rerank-metrics",
      "name": "Registrar Métricas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1570, 300]
    },
    {
      "parameters": {
      },
      "id": "prepare-enriched-context",
      "name": "Preparar Contexto Enriquecido",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1790, 300]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution", 
        "workflowId": "procesador-rag-reclamos",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-llm-generation",
      "name": "Activar Generación LLM",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 2,
      "position": [2010, 300]
    }
  ],
  "connections": {
    "Trigger ReRank": {
      "main": [[{"node": "Validar Entrada", "type": "main", "index": 0}]]
    },
    "Validar Entrada": {
      "main": [[{"node": "Obtener Config Cohere", "type": "main", "index": 0}]]
    },
    "Obtener Config Cohere": {
      "main": [[{"node": "Preparar Request Cohere", "type": "main", "index": 0}]]
    },
    "Preparar Request Cohere": {
      "main": [[{"node": "Llamar Cohere Rerank", "type": "main", "index": 0}]]
    },
    "Llamar Cohere Rerank": {
      "main": [[{"node": "Procesar Resultados", "type": "main", "index": 0}]]
    },
    "Procesar Resultados": {
      "main": [[{"node": "Registrar Métricas", "type": "main", "index": 0}]]
    },
    "Registrar Métricas": {
      "main": [[{"node": "Preparar Contexto Enriquecido", "type": "main", "index": 0}]]
    },
    "Preparar Contexto Enriquecido": {
      "main": [[{"node": "Activar Generación LLM", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "manejador-errores"
  },
  "staticData": {},
  "variables": {
    "RERANK_VERSION": "1.0.0",
    "DEFAULT_MODEL": "rerank-multilingual-v3.0",
    "DEFAULT_TOP_K": 5,
    "DEFAULT_THRESHOLD": 0.3,
    "MAX_DOCUMENTS": 100
  }
}