{
  "name": "RAG Processor - Simple",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/rag/process",
        "responseMode": "responseNode"
      },
      "id": "webhook-input",
      "name": "RAG Input",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "validate-normalize",
      "name": "Validate & Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https:
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "x-goog-api-key",
              "value": "={{ $vars.GEMINI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ { \"parts\": [{ \"text\": $json.query }] } }}"
            },
            {
              "name": "taskType",
              "value": "RETRIEVAL_QUERY"
            }
          ]
        }
      },
      "id": "generate-embedding",
      "name": "Generate Embedding",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.SUPABASE_URL }}/rest/v1/rpc/buscar_conocimiento_rag_contextual",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $vars.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "p_tenant_id",
              "value": "={{ $('Validate & Normalize').first().json.tenant_id }}"
            },
            {
              "name": "p_consulta",
              "value": "={{ $('Validate & Normalize').first().json.query }}"
            },
            {
              "name": "p_contexto",
              "value": "={{ $('Validate & Normalize').first().json.context }}"
            },
            {
              "name": "p_categoria",
              "value": null
            },
            {
              "name": "p_num_resultados",
              "value": 5
            },
            {
              "name": "p_threshold",
              "value": 0.7
            },
            {
              "name": "p_query_embedding",
              "value": "={{ JSON.stringify($('Generate Embedding').first().json.embedding.values) }}"
            }
          ]
        }
      },
      "id": "vector-search",
      "name": "Vector Search",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "build-prompt",
      "name": "Build AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https:
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "x-goog-api-key",
              "value": "={{ $vars.GEMINI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "contents",
              "value": "={{ [{ \"parts\": [{ \"text\": $json.prompt }] }] }}"
            },
            {
              "name": "generationConfig",
              "value": "={{ { \"temperature\": 0.1, \"topK\": 40, \"topP\": 0.8, \"maxOutputTokens\": 2048 } }}"
            }
          ]
        }
      },
      "id": "gemini-analysis",
      "name": "Gemini Analysis",
      "type": "n8n-nodes-base.httpRequestV3",
      "typeVersion": 4.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.SUPABASE_URL }}/rest/v1/rpc/registrar_consulta_rag",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "headers": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $vars.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $vars.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": {
          "parameters": [
            {
              "name": "p_tenant_id",
              "value": "={{ $('Build AI Prompt').first().json.query_data.tenant_id }}"
            },
            {
              "name": "p_consulta",
              "value": "={{ $('Build AI Prompt').first().json.query_data.query }}"
            },
            {
              "name": "p_contexto",
              "value": "={{ $('Build AI Prompt').first().json.query_data.context }}"
            },
            {
              "name": "p_chunks_usados",
              "value": "={{ $('Build AI Prompt').first().json.documents_found > 0 ? ['rag-chunk'] : [] }}"
            },
            {
              "name": "p_respuesta_ia",
              "value": "={{ $('Gemini Analysis').first().json.candidates[0]?.content?.parts[0]?.text || 'Error' }}"
            }
          ]
        },
        "continueOnFail": true
      },
      "id": "log-analytics",
      "name": "Log Analytics",
      "type": "n8n-nodes-base.httpRequestV3",  
      "typeVersion": 4.1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"query\": \"{{ $('Build AI Prompt').first().json.query_data.query }}\",\n  \"context\": \"{{ $('Build AI Prompt').first().json.query_data.context }}\",\n  \"rag_used\": {{ $('Build AI Prompt').first().json.has_context }},\n  \"documents_found\": {{ $('Build AI Prompt').first().json.documents_found }},\n  \"ai_analysis\": {{ $('Gemini Analysis').first().json.candidates[0]?.content?.parts[0]?.text || '{}' }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"tenant_id\": \"{{ $('Build AI Prompt').first().json.query_data.tenant_id }}\"\n}"
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2,
      "position": [1780, 300]
    }
  ],
  "connections": {
    "RAG Input": {
      "main": [
        [
          {
            "node": "Validate & Normalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate & Normalize": {
      "main": [
        [
          {
            "node": "Generate Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Embedding": {
      "main": [
        [
          {
            "node": "Vector Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vector Search": {
      "main": [
        [
          {
            "node": "Build AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Prompt": {
      "main": [
        [
          {
            "node": "Gemini Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Analysis": {
      "main": [
        [
          {
            "node": "Log Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Analytics": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "rag-simple",
      "name": "rag-simple"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "reclamos",
      "name": "reclamos"
    }
  ],
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "rag-processor-simple",
  "versionId": "1.0.0"
}