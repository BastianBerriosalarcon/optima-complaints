{
  "name": "Knowledge - Document Ingestion",
  "description": "Workflow enfocado en validar documentos y crear registro inicial. Principio SRP: Una sola responsabilidad - validación e ingesta.",
  "tags": [
    "rag",
    "knowledge",
    "ingestion",
    "srp"
  ],
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/knowledge/ingest",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-knowledge-input",
      "name": "Knowledge Upload Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        240,
        300
      ],
      "webhookId": "knowledge-ingestion"
    },
    {
      "parameters": {},
      "id": "validate-document-input",
      "name": "Validar Entrada de Documento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO documentos_conocimiento (concesionario_id, titulo, contenido_original, categoria, tags, autor, version, idioma, estado, metadatos) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *",
        "additionalFields": {
          "queryParameters": "={{ [$json.tenant_id, $json.document_title, $json.file_content, $json.category, JSON.stringify($json.tags), $json.author, $json.version, $json.language, 'procesando', JSON.stringify({original_filename: $json.original_filename, mime_type: $json.mime_type, content_length: $json.content_length})] }}"
        }
      },
      "id": "create-document-record",
      "name": "Crear Registro Documento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {},
      "id": "prepare-for-chunking",
      "name": "Preparar para Chunking",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2.1,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "knowledge-chunking",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-chunking-workflow",
      "name": "Iniciar Chunking",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 2.1,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Documento ingresado exitosamente. Iniciando procesamiento automático.\",\n  \"document_data\": {\n    \"id\": \"{{ $('Crear Registro Documento').first().json[0].id }}\",\n    \"title\": \"{{ $('Validar Entrada de Documento').first().json.document_title }}\",\n    \"content_length\": {{ $('Validar Entrada de Documento').first().json.content_length }},\n    \"category\": \"{{ $('Validar Entrada de Documento').first().json.category }}\",\n    \"status\": \"processing\",\n    \"next_step\": \"chunking\"\n  },\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "success-response",
      "name": "Respuesta Exitosa",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2.1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"error\",\n  \"message\": \"Error en la ingesta del documento.\",\n  \"error_details\": \"{{ $json.error?.message || 'Error desconocido en validación' }}\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "error-response",
      "name": "Respuesta de Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 2.1,
      "position": [
        460,
        500
      ]
    }
  ],
  "connections": {
    "Knowledge Upload Webhook": {
      "main": [
        [
          {
            "node": "Validar Entrada de Documento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Entrada de Documento": {
      "main": [
        [
          {
            "node": "Crear Registro Documento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta de Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Registro Documento": {
      "main": [
        [
          {
            "node": "Preparar para Chunking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar para Chunking": {
      "main": [
        [
          {
            "node": "Iniciar Escaneo de Malware",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iniciar Chunking": {
      "main": [
        [
          {
            "node": "Respuesta Exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}
