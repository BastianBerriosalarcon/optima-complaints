{
  "name": "Tenant - Búsqueda y Configuración con Caché",
  "description": "Workflow optimizado que identifica un tenant, obtiene su configuración (con caché) y la prepara para el siguiente paso.",
  "tags": [
    "tenant",
    "configuration",
    "srp",
    "refactored",
    "cache"
  ],
  "nodes": [
    {
      "parameters": {
        "workflowId": "{{ $json.workflowId }}"
      },
      "id": "workflow-trigger",
      "name": "Trigger del Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Verificar caché de configuración del tenant\nconst tenantId = $input.all()[0].json.tenant_id;\nconst cacheKey = `tenant_config_${tenantId}`;\n\n// Simular verificación de caché\nconst hasCache = false; // TODO: Implementar redis/memoria\n\nreturn [{\n  json: {\n    tenant_id: tenantId,\n    has_cache: hasCache,\n    cache_key: cacheKey\n  }\n}];"
      },
      "id": "check-tenant-cache",
      "name": "Check Tenant Cache",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        470,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.tenant_config_source}}",
              "operation": "equal",
              "value2": "database"
            }
          ]
        }
      },
      "id": "cache-miss-condition",
      "name": "Cache Miss?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        690,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.tenant_id_input ? 'SELECT id as tenant_id, nombre as tenant_name, telefono_principal, configuracion_ai, configuracion_horarios, activo FROM concesionarios WHERE id = $1 AND activo = true LIMIT 1' : 'SELECT id as tenant_id, nombre as tenant_name, telefono_principal, configuracion_ai, configuracion_horarios, activo FROM concesionarios WHERE whatsapp_phone_number_id = $1 AND activo = true LIMIT 1' }}",
        "additionalFields": {
          "queryParameters": "={{ [$json.tenant_id_input || $json.phone_number_id_input] }}"
        }
      },
      "id": "load-tenant-config-db",
      "name": "Load Config from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        910,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "update-cache",
      "name": "Update Cache",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1130,
        200
      ]
    },
    {
      "parameters": {
        "mode": "mergeByIndex"
      },
      "id": "merge-config-paths",
      "name": "Merge Config Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        1350,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "prepare-tenant-config",
      "name": "Preparar Configuración",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1570,
        300
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "resource": "execution",
        "workflowId": "lead-analysis-workflow",
        "data": "={{ JSON.stringify($json) }}"
      },
      "id": "trigger-lead-analysis",
      "name": "Iniciar Análisis de Lead",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 2,
      "position": [
        1790,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "
      },
      "id": "use-cached-config",
      "name": "Use Cached Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        910,
        400
      ]
    }
  ],
  "connections": {
    "Trigger del Workflow": {
      "main": [
        [
          {
            "node": "Check Tenant Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tenant Cache": {
      "main": [
        [
          {
            "node": "Cache Miss?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Miss?": {
      "main": [
        [
          {
            "node": "Load Config from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Use Cached Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Config from DB": {
      "main": [
        [
          {
            "node": "Update Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cache": {
      "main": [
        [
          {
            "node": "Merge Config Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Config Paths": {
      "main": [
        [
          {
            "node": "Preparar Configuración",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Configuración": {
      "main": [
        [
          {
            "node": "Iniciar Análisis de Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Use Cached Config": {
      "main": [
        [
          {
            "node": "Merge Config Paths",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}