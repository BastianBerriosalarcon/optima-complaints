{
  "name": "Notificador de Escalaci√≥n Autom√°tica",
  "description": "Workflow que monitorea leads, encuestas y reclamos sin atender por tiempo l√≠mite y escala autom√°ticamente a supervisores seg√∫n reglas de negocio cr√≠ticas.",
  "tags": [
    "escalacion",
    "notificaciones", 
    "supervision",
    "sla",
    "critico"
  ],
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Ejecutar cada hora",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- LEADS: ESCALACI√ìN INMEDIATA - Buscar leads sin contactar para escalaci√≥n instant√°nea\nSELECT \n  'lead' as tipo_item,\n  l.id as item_id,\n  l.concesionario_id,\n  l.telefono_cliente,\n  l.nombre_cliente,\n  l.mensaje_original,\n  l.score_calidad,\n  l.nivel_interes,\n  l.asesor_asignado_id,\n  l.estado,\n  l.fecha_creacion,\n  \n  -- Informaci√≥n del asesor asignado\n  asesor.nombre as asesor_nombre,\n  asesor.email as asesor_email,\n  \n  -- Informaci√≥n del supervisor (jefe de ventas)\n  supervisor.id as supervisor_id,\n  supervisor.nombre as supervisor_nombre,\n  supervisor.email as supervisor_email,\n  \n  -- Informaci√≥n del concesionario\n  c.nombre as concesionario_nombre,\n  c.configuracion_escalacion,\n  \n  -- C√°lculos de tiempo\n  EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - l.fecha_creacion))/60 as minutos_transcurridos,\n  \n  -- ESCALACI√ìN INMEDIATA: Todo es cr√≠tico despu√©s de 2 minutos\n  CASE \n    WHEN EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - l.fecha_creacion))/60 >= 2 THEN 'critico'\n    ELSE 'normal'\n  END as nivel_escalacion,\n  \n  'Lead sin contactar - Escalaci√≥n inmediata para captura r√°pida' as motivo_escalacion\n  \nFROM leads l\nINNER JOIN usuarios asesor ON l.asesor_asignado_id = asesor.id\nINNER JOIN usuarios supervisor ON asesor.concesionario_id = supervisor.concesionario_id AND supervisor.rol = 'jefe_ventas'\nINNER JOIN concesionarios c ON l.concesionario_id = c.id\nWHERE \n  l.estado = 'nuevo'\n  AND l.fecha_primer_contacto IS NULL\n  AND l.asesor_asignado_id IS NOT NULL\n  AND c.activo = true\n  AND asesor.activo = true\n  AND supervisor.activo = true\n  -- ESCALACI√ìN INMEDIATA: Despu√©s de 2 minutos\n  AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - l.fecha_creacion))/60 >= 2\n  -- Evitar escalaciones duplicadas en √∫ltimos 10 minutos\n  AND NOT EXISTS (\n    SELECT 1 FROM escalaciones e \n    WHERE e.item_type = 'lead' \n    AND e.item_id = l.id \n    AND e.created_at > CURRENT_TIMESTAMP - INTERVAL '10 minutes'\n  )\n\nUNION ALL\n\n-- RECLAMOS: ESCALACI√ìN INSTANT√ÅNEA - Al crearse ya est√°n asignados, escalamos si no hay acci√≥n\nSELECT \n  'reclamo' as tipo_item,\n  r.id as item_id,\n  r.concesionario_id,\n  c.telefono_principal as cliente_telefono,  -- Ajustado seg√∫n estructura de CLAUDE.md\n  'Cliente de ' || c.nombre as cliente_nombre,  -- Ajustado\n  r.detalle,\n  CASE WHEN r.black_alert THEN 100 ELSE 80 END as score_calidad,\n  CASE WHEN r.black_alert THEN 'alto' ELSE 'alto' END as nivel_interes,  -- Todos los reclamos son alta prioridad\n  COALESCE(asesor.id, jefe.id) as asesor_asignado_id,  -- Puede estar asignado al asesor o jefe directamente\n  r.estado,\n  r.fecha_creacion,\n  \n  -- Informaci√≥n del responsable actual\n  COALESCE(asesor.nombre, jefe.nombre) as asesor_nombre,\n  COALESCE(asesor.email, jefe.email) as asesor_email,\n  \n  -- Informaci√≥n del supervisor (siempre jefe de servicio)\n  jefe.id as supervisor_id,\n  jefe.nombre as supervisor_nombre,\n  jefe.email as supervisor_email,\n  \n  -- Informaci√≥n del concesionario\n  c.nombre as concesionario_nombre,\n  c.configuracion_escalacion,\n  \n  -- C√°lculos de tiempo\n  EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - r.fecha_creacion))/60 as minutos_transcurridos,\n  \n  -- ESCALACI√ìN INSTANT√ÅNEA: Todo es emergencia despu√©s de 1 minuto\n  CASE \n    WHEN r.black_alert AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - r.fecha_creacion))/60 >= 1 THEN 'emergencia'\n    WHEN NOT r.black_alert AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - r.fecha_creacion))/60 >= 1 THEN 'critico'\n    ELSE 'normal'\n  END as nivel_escalacion,\n  \n  CASE \n    WHEN r.black_alert THEN 'üö® RECLAMO BLACK ALERT - Cliente puede ir a SERNAC - ACCI√ìN INMEDIATA'\n    ELSE 'üî¥ RECLAMO CR√çTICO - Cliente insatisfecho - Contenci√≥n de da√±os inmediata'\n  END as motivo_escalacion\n  \nFROM reclamos r\nINNER JOIN concesionarios c ON r.concesionario_id = c.id\nINNER JOIN usuarios jefe ON c.id = jefe.concesionario_id AND jefe.rol = 'jefe_servicio'\nLEFT JOIN usuarios asesor ON r.asesor_asignado_id = asesor.id  -- Puede no tener asesor espec√≠fico asignado\nWHERE \n  r.estado IN ('pendiente', 'en_proceso')  -- Estados que requieren atenci√≥n\n  AND c.activo = true\n  AND jefe.activo = true\n  AND (asesor.activo = true OR asesor.id IS NULL)\n  -- ESCALACI√ìN INSTANT√ÅNEA: Despu√©s de 1 minuto\n  AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - r.fecha_creacion))/60 >= 1\n  -- Evitar escalaciones duplicadas en √∫ltimos 5 minutos\n  AND NOT EXISTS (\n    SELECT 1 FROM escalaciones e \n    WHERE e.item_type = 'reclamo' \n    AND e.item_id = r.id \n    AND e.created_at > CURRENT_TIMESTAMP - INTERVAL '5 minutes'\n  )\n\nORDER BY \n  nivel_escalacion DESC,\n  minutos_transcurridos DESC,\n  score_calidad DESC;"
      },
      "id": "query-items-for-escalation",
      "name": "Consultar Items para Escalaci√≥n",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-has-escalations",
      "name": "¬øHay Items para Escalar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [690, 300]
    },
    {
      "parameters": {
      },
      "id": "group-by-supervisor",
      "name": "Agrupar por Supervisor", 
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [910, 200]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "emailSmtp",
        "fromEmail": "escalaciones@optimacx.com",
        "toEmail": "={{ $json.supervisor_email }}",
        "ccEmail": "={{ $json.max_criticidad === 'emergencia' ? 'gerencia@optimacx.com' : '' }}",
        "subject": "üö® {{ $json.max_criticidad === 'emergencia' ? 'EMERGENCIA' : $json.max_criticidad === 'critico' ? 'CR√çTICO' : $json.max_criticidad === 'urgente' ? 'URGENTE' : 'IMPORTANTE' }} - Escalaci√≥n Autom√°tica ({{ $json.total_escalaciones }} items)",
        "html": "=<!DOCTYPE html>\n<html>\n<head>\n    <style>\n        .container { font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; }\n        .header { \n            background: {{ $json.max_criticidad === 'emergencia' ? '#8B0000' : $json.max_criticidad === 'critico' ? '#dc3545' : $json.max_criticidad === 'urgente' ? '#fd7e14' : '#ffc107' }}; \n            color: white; \n            padding: 20px; \n            text-align: center; \n            border-radius: 8px 8px 0 0;\n        }\n        .escalation-item { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }\n        .emergencia { border-left: 5px solid #8B0000; background-color: #fff5f5; }\n        .critico { border-left: 5px solid #dc3545; background-color: #fff5f5; }\n        .urgente { border-left: 5px solid #fd7e14; background-color: #fff8f0; }\n        .importante { border-left: 5px solid #ffc107; background-color: #fffef7; }\n        .client-info { font-weight: bold; color: #2c3e50; margin-bottom: 8px; }\n        .advisor-info { color: #7f8c8d; font-size: 0.9em; }\n        .time-critical { color: #e74c3c; font-weight: bold; }\n        .details { margin-top: 10px; font-style: italic; color: #5a6c7d; }\n        .cta { background: #dc3545; color: white; padding: 20px; text-align: center; margin: 20px 0; border-radius: 5px; }\n        .stats { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h2>{{ $json.max_criticidad === 'emergencia' ? 'üö® ESCALACI√ìN DE EMERGENCIA' : $json.max_criticidad === 'critico' ? 'üî¥ ESCALACI√ìN CR√çTICA' : $json.max_criticidad === 'urgente' ? 'üü† ESCALACI√ìN URGENTE' : 'üü° ESCALACI√ìN IMPORTANTE' }}</h2>\n            <p><strong>{{ $json.concesionario_nombre }}</strong></p>\n            <p>{{ new Date().toLocaleString('es-CL', { timeZone: 'America/Santiago' }) }}</p>\n        </div>\n        \n        <div style=\"padding: 20px;\">\n            <p><strong>{{ $json.supervisor_nombre }}</strong>,</p>\n            <p>Se han detectado <strong>{{ $json.total_escalaciones }} items</strong> que requieren tu intervenci√≥n inmediata por exceder los tiempos SLA establecidos.</p>\n            \n            <div class=\"stats\">\n                <h4>üìä Resumen de Escalaciones:</h4>\n                <ul>\n                    {{ $json.escalaciones_por_nivel.emergencia.length > 0 ? `<li><strong>üö® EMERGENCIA:</strong> ${$json.escalaciones_por_nivel.emergencia.length}</li>` : '' }}\n                    {{ $json.escalaciones_por_nivel.critico.length > 0 ? `<li><strong>üî¥ CR√çTICO:</strong> ${$json.escalaciones_por_nivel.critico.length}</li>` : '' }}\n                    {{ $json.escalaciones_por_nivel.urgente.length > 0 ? `<li><strong>üü† URGENTE:</strong> ${$json.escalaciones_por_nivel.urgente.length}</li>` : '' }}\n                    {{ $json.escalaciones_por_nivel.importante.length > 0 ? `<li><strong>üü° IMPORTANTE:</strong> ${$json.escalaciones_por_nivel.importante.length}</li>` : '' }}\n                </ul>\n            </div>\n            \n            {{ $json.escalaciones_por_nivel.emergencia.length > 0 ? `\n            <h3 style=\"color: #8B0000;\">üö® EMERGENCIA - Atenci√≥n INMEDIATA</h3>\n            ${$json.escalaciones_por_nivel.emergencia.map(item => `\n            <div class=\"escalation-item emergencia\">\n                <div class=\"client-info\">${item.tipo.toUpperCase()} #${item.id} - ${item.cliente.nombre}</div>\n                <div><strong>üìû ${item.cliente.telefono}</strong></div>\n                <div class=\"advisor-info\">Asesor: ${item.asesor.nombre} (${item.asesor.email})</div>\n                <div class=\"time-critical\">‚è∞ ${item.detalles.horas_transcurridas}h transcurridas</div>\n                <div><strong>Motivo:</strong> ${item.detalles.motivo}</div>\n                <div class=\"details\">${item.detalles.mensaje_resumen}</div>\n            </div>\n            `).join('')}\n            ` : '' }}\n            \n            {{ $json.escalaciones_por_nivel.critico.length > 0 ? `\n            <h3 style=\"color: #dc3545;\">üî¥ CR√çTICO - Resolver Hoy</h3>\n            ${$json.escalaciones_por_nivel.critico.map(item => `\n            <div class=\"escalation-item critico\">\n                <div class=\"client-info\">${item.tipo.toUpperCase()} #${item.id} - ${item.cliente.nombre}</div>\n                <div><strong>üìû ${item.cliente.telefono}</strong></div>\n                <div class=\"advisor-info\">Asesor: ${item.asesor.nombre} (${item.asesor.email})</div>\n                <div class=\"time-critical\">‚è∞ ${item.detalles.horas_transcurridas}h transcurridas</div>\n                <div><strong>Motivo:</strong> ${item.detalles.motivo}</div>\n                <div class=\"details\">${item.detalles.mensaje_resumen}</div>\n            </div>\n            `).join('')}\n            ` : '' }}\n            \n            {{ $json.escalaciones_por_nivel.urgente.length > 0 ? `\n            <h3 style=\"color: #fd7e14;\">üü† URGENTE - Atenci√≥n Prioritaria</h3>\n            ${$json.escalaciones_por_nivel.urgente.map(item => `\n            <div class=\"escalation-item urgente\">\n                <div class=\"client-info\">${item.tipo.toUpperCase()} #${item.id} - ${item.cliente.nombre}</div>\n                <div><strong>üìû ${item.cliente.telefono}</strong></div>\n                <div class=\"advisor-info\">Asesor: ${item.asesor.nombre} (${item.asesor.email})</div>\n                <div class=\"time-critical\">‚è∞ ${item.detalles.horas_transcurridas}h transcurridas</div>\n                <div><strong>Motivo:</strong> ${item.detalles.motivo}</div>\n                <div class=\"details\">${item.detalles.mensaje_resumen}</div>\n            </div>\n            `).join('')}\n            ` : '' }}\n            \n            {{ $json.escalaciones_por_nivel.importante.length > 0 ? `\n            <h3 style=\"color: #ffc107;\">üü° IMPORTANTE - Seguimiento Requerido</h3>\n            ${$json.escalaciones_por_nivel.importante.map(item => `\n            <div class=\"escalation-item importante\">\n                <div class=\"client-info\">${item.tipo.toUpperCase()} #${item.id} - ${item.cliente.nombre}</div>\n                <div><strong>üìû ${item.cliente.telefono}</strong></div>\n                <div class=\"advisor-info\">Asesor: ${item.asesor.nombre} (${item.asesor.email})</div>\n                <div class=\"time-critical\">‚è∞ ${item.detalles.horas_transcurridas}h transcurridas</div>\n                <div><strong>Motivo:</strong> ${item.detalles.motivo}</div>\n                <div class=\"details\">${item.detalles.mensaje_resumen}</div>\n            </div>\n            `).join('')}\n            ` : '' }}\n            \n            <div class=\"cta\">\n                <strong>‚ö° ACCI√ìN REQUERIDA:</strong><br>\n                {{ $json.requiere_atencion_inmediata ? 'Contacta INMEDIATAMENTE con los asesores responsables y verifica el estado de estos casos.' : 'Revisa y coordina con tu equipo la atenci√≥n de estos casos pendientes.' }}\n            </div>\n            \n            <div style=\"background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0;\">\n                <h4>üìã Acciones Recomendadas:</h4>\n                <ol>\n                    <li><strong>Contactar asesores</strong> para verificar estado actual</li>\n                    <li><strong>Reasignar casos</strong> si el asesor no est√° disponible</li>\n                    <li><strong>Contactar clientes</strong> para informar seguimiento</li>\n                    <li><strong>Actualizar sistema</strong> con acciones tomadas</li>\n                    {{ $json.max_criticidad === 'emergencia' ? '<li><strong>Informar a gerencia</strong> sobre casos de emergencia</li>' : '' }}\n                </ol>\n            </div>\n            \n            <p>üíª <strong>Acceder al sistema:</strong> <a href=\"https://app.optimacx.com/dashboard\">Dashboard Supervisi√≥n</a></p>\n            \n            <hr style=\"margin: 30px 0;\">\n            <p style=\"font-size: 0.9em; color: #6c757d;\">\n                <strong>Escalaci√≥n Autom√°tica - √ìptima-CX</strong><br>\n                Este email se env√≠a autom√°ticamente cuando se exceden los tiempos SLA establecidos.<br>\n                Para modificar configuraciones de escalaci√≥n, contacta al administrador del sistema.\n            </p>\n        </div>\n    </div>\n</body>\n</html>"
      },
      "id": "send-escalation-email",
      "name": "Enviar Email Escalaci√≥n",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [1130, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Registrar escalaciones enviadas para auditor√≠a\nINSERT INTO escalaciones (\n  item_type,\n  item_id,\n  concesionario_id,\n  asesor_id,\n  supervisor_id,\n  nivel_escalacion,\n  motivo,\n  horas_transcurridas,\n  metadata,\n  created_at\n)\nSELECT \n  unnest(ARRAY[{{ \n    $json.escalaciones_por_nivel.emergencia.concat(\n      $json.escalaciones_por_nivel.critico,\n      $json.escalaciones_por_nivel.urgente,\n      $json.escalaciones_por_nivel.importante\n    ).map(item => `'${item.tipo}'`).join(',') \n  }}]) as item_type,\n  unnest(ARRAY[{{ \n    $json.escalaciones_por_nivel.emergencia.concat(\n      $json.escalaciones_por_nivel.critico,\n      $json.escalaciones_por_nivel.urgente,\n      $json.escalaciones_por_nivel.importante\n    ).map(item => item.id).join(',') \n  }}]) as item_id,\n  $1 as concesionario_id,\n  unnest(ARRAY[{{ \n    $json.escalaciones_por_nivel.emergencia.concat(\n      $json.escalaciones_por_nivel.critico,\n      $json.escalaciones_por_nivel.urgente,\n      $json.escalaciones_por_nivel.importante\n    ).map(item => `'${item.asesor.email}'`).join(',') \n  }}]) as asesor_id,\n  $2 as supervisor_id,\n  $3 as nivel_escalacion,\n  'Escalaci√≥n autom√°tica por exceso de tiempo SLA' as motivo,\n  unnest(ARRAY[{{ \n    $json.escalaciones_por_nivel.emergencia.concat(\n      $json.escalaciones_por_nivel.critico,\n      $json.escalaciones_por_nivel.urgente,\n      $json.escalaciones_por_nivel.importante\n    ).map(item => item.detalles.horas_transcurridas).join(',') \n  }}]) as horas_transcurridas,\n  $4::jsonb as metadata,\n  CURRENT_TIMESTAMP as created_at\nRETURNING *;",
        "additionalFields": {
          "queryParameters": "=[\n  $json.concesionario_id,\n  $json.supervisor_id,\n  $json.max_criticidad,\n  JSON.stringify({\n    total_escalaciones: $json.total_escalaciones,\n    distribucion: {\n      emergencia: $json.escalaciones_por_nivel.emergencia.length,\n      critico: $json.escalaciones_por_nivel.critico.length,\n      urgente: $json.escalaciones_por_nivel.urgente.length,\n      importante: $json.escalaciones_por_nivel.importante.length\n    }\n  })\n]"
        }
      },
      "id": "log-escalations",
      "name": "Registrar Escalaciones",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1350, 200]
    },
    {
      "parameters": {
      },
      "id": "generate-escalation-summary",
      "name": "Generar Resumen Escalaciones",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1570, 200]
    },
    {
      "parameters": {
      },
      "id": "no-escalations-response",
      "name": "Sin Escalaciones",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [910, 400]
    }
  ],
  "connections": {
    "Ejecutar cada hora": {
      "main": [[{"node": "Consultar Items para Escalaci√≥n", "type": "main", "index": 0}]]
    },
    "Consultar Items para Escalaci√≥n": {
      "main": [[{"node": "¬øHay Items para Escalar?", "type": "main", "index": 0}]]
    },
    "¬øHay Items para Escalar?": {
      "main": [
        [{"node": "Agrupar por Supervisor", "type": "main", "index": 0}],
        [{"node": "Sin Escalaciones", "type": "main", "index": 0}]
      ]
    },
    "Agrupar por Supervisor": {
      "main": [[{"node": "Enviar Email Escalaci√≥n", "type": "main", "index": 0}]]
    },
    "Enviar Email Escalaci√≥n": {
      "main": [[{"node": "Registrar Escalaciones", "type": "main", "index": 0}]]
    },
    "Registrar Escalaciones": {
      "main": [[{"node": "Generar Resumen Escalaciones", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "manejador-errores"
  },
  "staticData": {},
  "variables": {
    "ESCALATION_VERSION": "2.0.0",
    "ESCALATION_MODE": "IMMEDIATE",
    "LEAD_ESCALATION_MINUTES": 2,
    "COMPLAINT_BLACK_ALERT_MINUTES": 1,
    "COMPLAINT_NORMAL_MINUTES": 1,
    "ANTI_SPAM_LEAD_MINUTES": 10,
    "ANTI_SPAM_COMPLAINT_MINUTES": 5
  }
}