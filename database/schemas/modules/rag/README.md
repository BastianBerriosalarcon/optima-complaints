# RAG (Retrieval Augmented Generation) Database Functions

This directory contains the database functions and schemas required for the RAG functionality in the Ã“ptima-CX complaint processing system.

## Files

- `01_rag_tables.sql` - Core RAG tables (documentos_conocimiento, documento_chunks)
- `02_search_knowledge_base_function.sql` - Vector similarity search function

## search_knowledge_base Function

This function is used by the N8N workflow `complaint-rag-processor.json` to perform vector similarity searches on the knowledge base.

### Parameters

- `query_embedding` (vector(768)): The embedding vector of the query (generated by Gemini)
- `tenant_filter` (text): The concesionario_id to filter results by tenant
- `similarity_threshold` (float, default 0.7): Minimum similarity score to include in results
- `max_results` (int, default 10): Maximum number of results to return

### Returns

Table with columns:
- `id` (uuid): Chunk ID
- `contenido` (text): Text content of the chunk
- `similarity` (float): Similarity score (0.0 to 1.0)
- `metadata` (jsonb): Metadata associated with the chunk
- `documento_id` (uuid): ID of the source document
- `chunk_index` (int): Index of the chunk within the document

### Usage in N8N

The function is called from the complaint RAG processor workflow to retrieve relevant knowledge base content based on the complaint text embedding.

## Deployment Instructions

### Option 1: Supabase Dashboard (Recommended)

1. Go to your Supabase project dashboard: https://supabase.com/dashboard/project/omsxsirtxfrvxiddhmxr
2. Navigate to "SQL Editor"
3. Create a new query
4. Copy and paste the contents of `02_search_knowledge_base_function.sql`
5. Execute the query

### Option 2: Supabase CLI

```bash
# If you have the Supabase CLI installed and configured
supabase db reset --db-url "your-connection-string" --file database/schemas/modules/rag/02_search_knowledge_base_function.sql
```

### Option 3: psql

```bash
# Using psql directly
psql "your-connection-string" -f database/schemas/modules/rag/02_search_knowledge_base_function.sql
```

## Prerequisites

Before deploying this function, ensure that:

1. The `pgvector` extension is enabled in your Supabase project
2. The base RAG tables have been created (run `01_rag_tables.sql` first)
3. The `vector(768)` type is available (matches Gemini embedding dimensions)

## Testing

After deployment, you can test the function with:

```sql
-- Test the function (replace with actual embedding and tenant ID)
SELECT * FROM search_knowledge_base(
  '[0.1, 0.2, ...]'::vector(768),  -- Sample embedding
  'your-tenant-id',
  0.7,
  5
);
```

## Security

The function is created with `SECURITY DEFINER` to ensure it runs with the privileges of the function owner, and permissions are granted to both `service_role` and `authenticated` users as needed by the N8N workflows.